# __Nasal è„šæœ¬è¯­è¨€__

```C++
       __                _
    /\ \ \__ _ ___  __ _| |
   /  \/ / _` / __|/ _` | |
  / /\  / (_| \__ \ (_| | |
  \_\ \/ \__,_|___/\__,_|_|
```

![GitHub code size in bytes](https://img.shields.io/github/languages/code-size/ValKmjolnir/Nasal-Interpreter?style=flat-square&logo=github)
![GitHub release (latest by date)](https://img.shields.io/github/v/release/ValKmjolnir/Nasal-Interpreter?style=flat-square&logo=github)
![in dev](https://img.shields.io/badge/dev-v10.0-blue?style=flat-square&logo=github)
[![license](https://img.shields.io/badge/license-MIT-green?style=flat-square&logo=github)](../LICENSE)

> è¿™ç¯‡æ–‡æ¡£åŒ…å«å¤šç§è¯­è¨€ç‰ˆæœ¬: [__ä¸­æ–‡__](../doc/README_zh.md) | [__English__](../README.md)

## __ç›®å½•__

* [__ç®€ä»‹__](#ç®€ä»‹)
* [__ç¼–è¯‘__](#ç¼–è¯‘æ–¹å¼)
* [__ä½¿ç”¨æ–¹æ³•__](#ä½¿ç”¨æ–¹æ³•)
* [__æ•™ç¨‹__](#æ•™ç¨‹)
  * [åŸºæœ¬ç±»å‹](#åŸºæœ¬ç±»å‹)
  * [è¿ç®—ç¬¦](#è¿ç®—ç¬¦)
  * [å®šä¹‰å˜é‡](#å®šä¹‰å˜é‡)
  * [å¤šå˜é‡èµ‹å€¼](#å¤šå˜é‡èµ‹å€¼)
  * [æ¡ä»¶è¯­å¥](#æ¡ä»¶è¯­å¥)
  * [å¾ªç¯è¯­å¥](#å¾ªç¯è¯­å¥)
  * [ç”Ÿæˆå­åˆ—è¡¨](#ç”Ÿæˆå­åˆ—è¡¨)
  * [ç‰¹æ®Šå‡½æ•°è°ƒç”¨è¯­æ³•](#ç‰¹æ®Šå‡½æ•°è°ƒç”¨è¯­æ³•)
  * [lambdaè¡¨è¾¾å¼](#lambdaè¡¨è¾¾å¼)
  * [é—­åŒ…](#é—­åŒ…)
  * [trait(ç‰¹æ€§)](#ç‰¹æ€§)
  * [å†…ç½®å‡½æ•°](#å†…ç½®å‡½æ•°)
  * [æ¨¡å—](#æ¨¡å—å¼€å‘è€…æ•™ç¨‹)
* [__å‘è¡Œæ—¥å¿—__](#å‘è¡Œæ—¥å¿—)
  * [v8.0](#version-80-release)
* [__è¯­æ³•åˆ†æ__](#è¯­æ³•åˆ†æ)
  * [v1.0](#version-10-parser-last-update-20191014)
* [__æŠ½è±¡è¯­æ³•æ ‘__](#æŠ½è±¡è¯­æ³•æ ‘)
  * [v1.2](#version-12-ast-last-update-20191031)
  * [v2.0](#version-20-ast-last-update-2020831)
  * [v3.0](#version-30-ast-last-update-20201023)
  * [v5.0](#version-50-ast-last-update-202137)
* [__å­—èŠ‚ç è™šæ‹Ÿæœº__](#å­—èŠ‚ç è™šæ‹Ÿæœº)
  * [v4.0](#version-40-vm-last-update-20201217)
  * [v5.0](#version-50-vm-last-update-202137)
  * [v6.0](#version-60-vm-last-update-202161)
  * [v6.5](#version-65-vm-last-update-2021624)
  * [v7.0](#version-70-vm-last-update-2021108)
  * [v8.0](#version-80-vm-last-update-2022212)
  * [v9.0](#version-90-vm-last-update-2022518)
  * [v10.0](#version-100-vm-latest)
* [__æµ‹è¯•æ•°æ®__](#æµ‹è¯•æ•°æ®)
  * [v6.5 (i5-8250U windows 10)](#version-65-i5-8250u-windows10-2021619)
  * [v6.5 (i5-8250U ubuntu-WSL)](#version-70-i5-8250u-ubuntu-wsl-on-windows10-2021629)
  * [v8.0 (R9-5900HX ubuntu-WSL)](#version-80-r9-5900hx-ubuntu-wsl-2022123)
  * [v9.0 (R9-5900HX ubuntu-WSL)](#version-90-r9-5900hx-ubuntu-wsl-2022213)
* [__ç‰¹æ®Šä¹‹å¤„__](#ä¸andyè§£é‡Šå™¨çš„ä¸åŒä¹‹å¤„)
  * [ä¸¥æ ¼çš„å®šä¹‰è¦æ±‚](#1-å¿…é¡»ç”¨varå®šä¹‰å˜é‡)
  * [(å·²è¿‡æ—¶)åœ¨å®šä¹‰åè°ƒç”¨å˜é‡](#2-ç°åœ¨å·²ç»æ”¯æŒ-ä¸èƒ½åœ¨å®šä¹‰å‰ä½¿ç”¨å˜é‡)
  * [é»˜è®¤ä¸å®šé•¿å‚æ•°](#3-é»˜è®¤ä¸å®šé•¿å‚æ•°)
* [__å †æ ˆè¿½è¸ªä¿¡æ¯__](#trace-back-info)
  * [å†…ç½®å‡½æ•°`die`](#1-å†…ç½®å‡½æ•°die)
  * [æ ˆæº¢å‡º](#2-æ ˆæº¢å‡ºä¿¡æ¯)
  * [è¿è¡Œæ—¶é”™è¯¯](#3-è¿è¡Œæ—¶é”™è¯¯)
  * [è¯¦ç»†çš„å´©æºƒä¿¡æ¯](#4-è¯¦ç»†çš„å´©æºƒä¿¡æ¯)
* [__è°ƒè¯•å™¨__](#è°ƒè¯•å™¨)

__å¦‚æœæœ‰å¥½çš„æ„è§æˆ–å»ºè®®ï¼Œæ¬¢è¿è”ç³»æˆ‘ä»¬!__

* __E-mail__: __lhk101lhk101@qq.com__

* __QQ__: __896693328__

## __ç®€ä»‹__

__[Nasal](http://wiki.flightgear.org/Nasal_scripting_language)__
æ˜¯ä¸€ä¸ªä¸ECMAscriptæ ‡å‡†è¯­æ³•è®¾è®¡ç›¸ä¼¼çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¹¶ä¸”ä½œä¸ºè¿è¡Œè„šæœ¬è¯­è¨€è¢«è‘—åçš„å¼€æºé£è¡Œæ¨¡æ‹Ÿå™¨ __[FlightGear](https://www.flightgear.org/)__ æ‰€ä¾èµ–ã€‚
è¯¥è¯­è¨€çš„è®¾è®¡è€…å’Œåˆç‰ˆè§£é‡Šå™¨å®ç°è€…ä¸º __[Andy Ross](https://github.com/andyross)__ã€‚

è¿™ä¸ªè§£é‡Šå™¨é¡¹ç›®åˆ™ç”± __[ValKmjolnir](https://github.com/ValKmjolnir)__ å®Œå…¨ä½¿ç”¨ `C++`(`-std=c++11`)é‡æ–°å®ç°ï¼Œæ²¡æœ‰å¤ç”¨ __[Andy Rossçš„nasalè§£é‡Šå™¨](<https://github.com/andyross/nasal>)__ ä¸­çš„ä»»ä½•ä¸€è¡Œä»£ç ã€‚å°½ç®¡æ²¡æœ‰ä»»ä½•çš„å‚è€ƒä»£ç ï¼Œæˆ‘ä»¬ä¾ç„¶éå¸¸æ„Ÿè°¢Andyä¸ºæˆ‘ä»¬å¸¦æ¥äº†è¿™æ ·ä¸€ä¸ªç¥å¥‡ä¸”å®¹æ˜“ä¸Šæ‰‹çš„ç¼–ç¨‹è¯­è¨€ã€‚

ç°åœ¨è¿™ä¸ªé¡¹ç›®å·²ç»ä½¿ç”¨ __MIT åè®®__ å¼€æº (2021/5/4)ã€‚æ ¹æ®è¯¥åè®®çš„å†…å®¹ï¼Œä½ ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨å®ƒæ¥å­¦ä¹ æˆ–è€…åˆ›é€ æ›´å¤šæœ‰è¶£çš„ä¸œè¥¿(ä¸è¿‡å¯åˆ«å¿˜äº†ï¼Œå¦‚æœè¦å¼€æºå¿…é¡»è¦é™„å¸¦æœ¬é¡¹ç›®æ‹¥æœ‰è€…çš„ç›¸å…³ä¿¡æ¯)ã€‚

__æˆ‘ä»¬ä¸ºä»€ä¹ˆæƒ³è¦é‡æ–°å†™ä¸€ä¸ªnasalè§£é‡Šå™¨?__
è¿™æ˜¯ä¸ªå¾ˆå¶ç„¶çš„æƒ³æ³•ã€‚2019å¹´æš‘å‡ï¼Œ__[FGPRC](https://www.fgprc.org/)__ çš„æˆå‘˜å‘Šè¯‰æˆ‘ï¼Œåœ¨Flightgearä¸­æä¾›çš„nasalæ§åˆ¶å°çª—å£ä¸­è¿›è¡Œè°ƒè¯•å®åœ¨æ˜¯å¤ªè´¹åŠ²äº†ï¼Œæœ‰æ—¶å€™åªæ˜¯æƒ³æ£€æŸ¥è¯­æ³•é”™è¯¯ï¼Œä¹Ÿå¾—èŠ±è´¹æ—¶é—´æ‰“å¼€è¿™ä¸ªè½¯ä»¶ç­‰å¾…åŠ è½½è¿›å»ä¹‹åè¿›è¡Œè°ƒè¯•ã€‚æ‰€ä»¥æˆ‘å°±æƒ³ï¼Œä¹Ÿè®¸å¯ä»¥å†™ä¸€ä¸ªå…¨æ–°çš„è§£é‡Šå™¨æ¥å¸®åŠ©ä»–ä»¬æ£€æŸ¥è¯­æ³•é”™è¯¯ï¼Œç”šè‡³æ˜¯æ£€æŸ¥è¿è¡Œæ—¶çš„é”™è¯¯ã€‚

æˆ‘ç¼–å†™äº†nasalçš„è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨ï¼Œä»¥åŠä¸€ä¸ªå…¨æ–°çš„å­—èŠ‚ç è™šæ‹Ÿæœº(æ›¾ç»æˆ‘ä»¬ä½¿ç”¨astè§£é‡Šå™¨æ¥ç›´æ¥åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸­æ‰§è¡Œï¼Œç„¶è€Œåœ¨v4.0ä¹‹åè¿™ä¸ªè§£é‡Šå™¨å·²ç»æ·˜æ±°)ï¼Œå¹¶ç”¨è¿™ä¸ªè¿è¡Œæ—¶æ¥è¿›è¡Œnasalç¨‹åºçš„è°ƒè¯•ã€‚æˆ‘ä»¬å‘ç°ä½¿ç”¨è¿™ä¸ªè§£é‡Šå™¨æ¥æ£€æµ‹è¯­æ³•å’Œè¿è¡Œæ—¶é”™è¯¯éå¸¸å¿«æ·ï¼Œè¿œæ¯”æ¯æ¬¡éƒ½éœ€è¦å¤åˆ¶nasalä»£ç åˆ°Flightgearçš„nasalæ§åˆ¶å°ä¸­å»æŸ¥çœ‹è¦æ–¹ä¾¿ï¼Œä¸”é”™è¯¯ä¿¡æ¯æ¸…æ™°ç›´è§‚ã€‚

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­è¨€æ¥å†™ä¸€äº›ä¸Flightgearè¿è¡Œç¯å¢ƒæ— å…³çš„å…¶ä»–æœ‰è¶£çš„ç¨‹åº(å®ƒæ¯•ç«Ÿå°±æ˜¯ä¸ªè„šæœ¬è¯­è¨€)ï¼Œå¹¶ç”¨è¿™ä¸ªè§£é‡Šå™¨æ¥æ‰§è¡Œï¼Œè®©è¿™ä¸ªè¯­è¨€è„±ç¦»Flightgearçš„ç¯å¢ƒï¼Œå»åˆ«çš„åœ°æ–¹å¤§å±•èº«æ‰‹ã€‚ä½ ä¹Ÿå¯ä»¥ç¼–å†™ä½ è‡ªå·±çš„æ¨¡å—ï¼Œè®©nasalæ¥è°ƒç”¨ï¼Œä½¿å¾—è¿™ä¸ªè¯­è¨€æˆä¸ºä½ çš„é¡¹ç›®ä¸­ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚

## __ç¼–è¯‘æ–¹å¼__

![windows](https://img.shields.io/badge/Microsoft-Windows-green?style=flat-square&logo=windows)
![macOS](https://img.shields.io/badge/Apple%20Inc.-MacOS-green?style=flat-square&logo=apple)
![linux](https://img.shields.io/badge/GNU-Linux-green?style=flat-square&logo=GNU)

æˆ‘ä»¬æ¨èä½ ä¸‹è½½æœ€æ–°æ›´æ–°çš„ä»£ç åŒ…æ¥ç›´æ¥ç¼–è¯‘ï¼Œè¿™ä¸ªé¡¹ç›®éå¸¸å°å·§å› æ­¤ä½ å¯ä»¥éå¸¸å¿«é€Ÿåœ°å°†å®ƒç¼–è¯‘å‡ºæ¥ã€‚

__æ³¨æ„__: å¦‚æœä½ æƒ³ç›´æ¥ä¸‹è½½å‘è¡Œç‰ˆæä¾›çš„zip/tar.gzå‹ç¼©åŒ…æ¥æ„å»ºè¿™ä¸ªè§£é‡Šå™¨ï¼Œåœ¨ä¸‹è½½ä¹‹åè¯·é˜…è¯»ä¸‹æ–‡ä¸­å¯¹åº”å‘è¡Œç‰ˆæœ¬çš„[__å‘è¡Œæ—¥å¿—__](#å‘è¡Œæ—¥å¿—)ä»¥ä¿è¯è¿™ä¸ªå‘è¡Œç‰ˆçš„æ–‡ä»¶ä¸­ä¸åŒ…å«éå¸¸ä¸¥é‡çš„bug(æœ‰çš„ä¸¥é‡bugéƒ½æ˜¯åœ¨å‘è¡Œä¹‹åæ‰å‘ç°ï¼Œéå¸¸æå¿ƒæ€)ã€‚åœ¨å‘è¡Œç‰ˆæ—¥å¿—ä¸­æˆ‘ä»¬ä¼šå‘ŠçŸ¥å¦‚ä½•åœ¨ä»£ç ä¸­æ‰‹åŠ¨ä¿®å¤è¿™ä¸ªä¸¥é‡çš„bugã€‚

[![please use MinGW](https://www.mingw-w64.org/header.svg)](https://www.mingw-w64.org/ "Windowsç”¨æˆ·è¯·ä¸€å®šè¦ä½¿ç”¨MinGWç¼–è¯‘ï¼")

__Windowsç”¨æˆ·è¯·ä¸€å®šä¸€å®šä¸€å®šè¦ä½¿ç”¨MinGWç¼–è¯‘ï¼__

![g++](https://img.shields.io/badge/GNU-g++-A42E2B?style=flat-square&logo=GNU)
![clang++](https://img.shields.io/badge/LLVM-clang++-262D3A?style=flat-square&logo=LLVM)

__`Windows`__(`MinGW-w64`)ç”¨æˆ·ä½¿ç”¨g++ç¼–è¯‘å™¨å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡Œç¼–è¯‘. æ²¡æœ‰ç¼–è¯‘ç¯å¢ƒçš„è¯·åœ¨[__è¿™é‡Œ__](https://www.mingw-w64.org/downloads/)ä¸‹è½½MinGW-w64ã€‚(ç¼–è¯‘ä¸å‡ºæ¥åˆ«æ€ªæˆ‘æ²¡è¯´å“¦ğŸ‘¿)

> g++ -std=c++11 -O3 main.cpp -o nasal.exe -fno-exceptions -static

__`linux/macOS/Unix`__ ç”¨æˆ·å¯ä»¥ä½¿ç”¨g++æˆ–è€…clang++æ›¿ä»£ä¸‹é¢å‘½ä»¤ä¸­ä¸­æ‹¬å·çš„éƒ¨åˆ†æ¥è¿›è¡Œç¼–è¯‘ã€‚

> [cpp compiler] -std=c++11 -O3 main.cpp -o nasal -fno-exceptions -ldl

å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨makefileï¼Œ`mingw32-make`æ˜¯ __`Windows(MinGW-w64)`__ å¹³å°çš„`make`:

> mingw32-make nasal.exe
>
> mingw32-make.exe nasal.exe

__`linux/macOS/Unix`__ å¹³å°ç›´æ¥ä½¿ç”¨makeå³å¯:

> make nasal

## __ä½¿ç”¨æ–¹æ³•__

é¦–å…ˆæˆ‘ä»¬è¦é€šè¿‡[__æ•™ç¨‹__](#æ•™ç¨‹)çŸ¥é“è¿™ä¸ªè¯­è¨€çš„è¯­æ³•ä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™ä¸ªè§£é‡Šå™¨æ¥è¿è¡Œnasalç¨‹åºã€‚

è¾“å…¥ä¸‹é¢çš„å‘½ä»¤æ¥ __ç›´æ¥__ æ‰§è¡Œ:

> ./nasal filename

ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å¯ä»¥ç”¨äºæŸ¥çœ‹è§£é‡Šå™¨çš„ç‰ˆæœ¬:

> ./nasal -v
>
> ./nasal --version

```bash
       __                _
    /\ \ \__ _ ___  __ _| |
   /  \/ / _` / __|/ _` | |
  / /\  / (_| \__ \ (_| | |
  \_\ \/ \__,_|___/\__,_|_|
nasal ver : 10.0
c++ std   : 201103
thanks to : https://github.com/andyross/nasal
code repo : https://github.com/ValKmjolnir/Nasal-Interpreter
code repo : https://gitee.com/valkmjolnir/Nasal-Interpreter
lang info : http://wiki.flightgear.org/Nasal_scripting_language
input <nasal -h> to get help .
```

ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å¯ä»¥ç”¨äºæŸ¥çœ‹å¸®åŠ©(è°ƒè¯•å™¨çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥è¿›å…¥è°ƒè¯•æ¨¡å¼ä¹‹åæ ¹æ®æç¤ºæ¥æŸ¥è¯¢):

> ./nasal -h
>
> ./nasal --help

```bash
     ,--#-,
<3  / \____\  <3
    |_|__A_|
nasal <option>
option:
    -h, --help    | get help.
    -v, --version | get version of nasal interpreter.

nasal <file>
file:
    input file name to execute script file.

nasal [options...] <file>
option:
    -l,   --lex     | view token info.
    -a,   --ast     | view abstract syntax tree.
    -c,   --code    | view bytecode.
    -e,   --exec    | execute.
    -t,   --time    | execute and get the running time.
    -o,   --opcnt   | execute and count used operands.
    -d,   --detail  | execute and get detail crash info.
                    | get garbage collector info if did not crash.
    -op,  --optimize| use optimizer(beta).
                    | if want to use -op and run, please use -op -e/-t/-o/-d.
    -dbg, --debug   | debug mode (this will ignore -t -o -d).
file:
    input file name to execute script file.
```

å¦‚æœä½ çš„æ“ä½œç³»ç»Ÿæ˜¯ __`Windows`__ å¹¶ä¸”ä½ æƒ³è¾“å‡ºunicodeï¼Œè¯·ä¿è¯ä½ çš„æ§åˆ¶å°ç¨‹åºçš„ä»£ç é¡µæ”¯æŒutf-8ï¼Œè‹¥ä¸æ”¯æŒï¼Œä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤å¯ç”¨ä»£ç é¡µ:

> chcp 65001

æˆ–è€…ä½ å¯ä»¥ç›´æ¥åœ¨nasalä»£ç é‡Œå†™è¿™ä¸ªæ¥å¼€å¯:

```javascript
if(os.platform()=="windows")
    system("chcp 65001");
```

## __æ•™ç¨‹__

nasalæ˜¯éå¸¸å®¹æ˜“ä¸Šæ‰‹çš„ï¼Œä½ ç”šè‡³å¯ä»¥åœ¨15åˆ†é’Ÿä¹‹å†…çœ‹å®Œè¿™é‡Œçš„åŸºæœ¬æ•™ç¨‹å¹¶ä¸”ç›´æ¥å¼€å§‹ç¼–å†™ä½ æƒ³è¦çš„ç¨‹åºã€‚
__å¦‚æœä½ å…ˆå‰å·²ç»æ˜¯C/C++,javascripté€‰æ‰‹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•™ç¨‹å‡ ä¹å¯ä»¥ä¸ç”¨çœ‹äº†â€¦â€¦__ åœ¨çœ‹å®Œè¯¥æ•™ç¨‹ä¹‹åï¼ŒåŸºæœ¬ä¸Šä½ å°±å®Œå…¨æŒæ¡äº†è¿™ä¸ªè¯­è¨€:

### __åŸºæœ¬ç±»å‹__

__`vm_none`__ æ˜¯ç‰¹æ®Šçš„é”™è¯¯ç±»å‹ã€‚è¿™ä¸ªç±»å‹ç”¨äºç»ˆæ­¢è™šæ‹Ÿæœºçš„æ‰§è¡Œï¼Œç”¨æˆ·æ˜¯æ— æ³•ç”³è¯·åˆ°è¿™ä¸ªç±»å‹çš„ï¼Œè¯¥ç±»å‹åªèƒ½ç”±å­—èŠ‚ç è™šæ‹Ÿæœºè‡ªå·±åœ¨æŠ›å‡ºé”™è¯¯æ—¶äº§ç”Ÿã€‚

__`vm_nil`__ æ˜¯ç©ºç±»å‹ã€‚ç±»ä¼¼äºnullã€‚

```javascript
var spc=nil;
```

__`vm_num`__ æœ‰ä¸‰ç§å½¢å¼:åè¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ä»¥åŠå…«è¿›åˆ¶ã€‚å¹¶ä¸”è¯¥ç±»å‹ä½¿ç”¨IEEE754æ ‡å‡†çš„æµ®ç‚¹æ•°doubleæ ¼å¼æ¥å­˜å‚¨ã€‚

```javascript
# this language use '#' to write notes
var n=1;          # dec
var n=2.71828;    # dec
var n=2.147e16;   # dec
var n=1e-10;      # dec
var n=0x7fffffff; # hex
var n=0xAA55;     # hex
var n=0o170001;   # oct
```

__`vm_str`__ ä¹Ÿæœ‰ä¸‰ç§ä¸åŒçš„æ ¼å¼ã€‚ç¬¬ä¸‰ç§åªå…è®¸åŒ…å«ä¸€ä¸ªçš„å­—ç¬¦ã€‚

```javascript
var s='str';
var s="another string";
var s=`c`;

# è¯¥è¯­è¨€ä¹Ÿæ”¯æŒä¸€äº›ç‰¹åˆ«çš„è½¬ä¹‰å­—ç¬¦:

'\a';
'\b';
'\e';
'\f';
'\n';
'\r';
'\t';
'\v';
'\0';
'\\';
'\?';
'\'';
'\"';
```

__`vm_vec`__ æœ‰ä¸å—é™åˆ¶çš„é•¿åº¦å¹¶ä¸”å¯ä»¥å­˜å‚¨æ‰€æœ‰ç±»å‹çš„æ•°æ®ã€‚(å½“ç„¶ä¸èƒ½è¶…è¿‡å¯åˆ†é…å†…å­˜ç©ºé—´çš„é•¿åº¦)

```javascript
var vec=[];
var vec=[
    0,
    nil,
    {},
    [],
    func(){return 0;}
];
append(vec,0,1,2);
```

__`vm_hash`__ ä½¿ç”¨å“ˆå¸Œè¡¨(ç±»ä¼¼äº`python`ä¸­çš„å­—å…¸)ï¼Œé€šè¿‡é”®å€¼å¯¹æ¥å­˜å‚¨æ•°æ®ã€‚keyå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚

```javascript
var hash={
    member1:nil,
    member2:'str',
    'member3':'member\'s name can also be a string constant',
    "member4":"also this",
    function:func(){
        var a=me.member2~me.member3;
        return a;
    }
};
```

__`vm_func`__ å‡½æ•°ç±»å‹ã€‚(å®é™…ä¸Šåœ¨è¿™ä¸ªè¯­è¨€é‡Œå‡½æ•°ä¹Ÿæ˜¯ä¸€ç§lambdaè¡¨è¾¾å¼)

```javascript
var f=func(x,y,z){
    return nil;
}
var f=func{
    return 1024;
}
var f=func(x,y,z,default1=1,default2=2){
    return x+y+z+default1+default2;
}
var f=func(args...){
    var sum=0;
    foreach(var i;args)
        sum+=i;
    return sum;
}
```

__`vm_upval`__ æ˜¯ç”¨äºå­˜å‚¨é—­åŒ…æ•°æ®çš„ç‰¹æ®Šç±»å‹ã€‚è¿™ç§ç±»å‹åªåœ¨`nasal_vm`ä¸­ä½¿ç”¨ï¼Œç”¨äºç¡®ä¿é—­åŒ…æ˜¯å¯ä»¥æ­£ç¡®ä½¿ç”¨çš„ã€‚

__`vm_obj`__ æ˜¯ä¸€ç§ç”¨æ¥å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®çš„ç‰¹åˆ«ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨nasalä¸­ä½¿ç”¨C/C++çš„ä¸€äº›å¤æ‚æ•°æ®ç»“æ„ã€‚å¦‚æœä½ æƒ³ä¸ºnasalæ·»åŠ ä¸€ç§æ–°çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»å‹çš„æ•°æ®ã€‚è¿™ç§ç±»å‹çš„æ•°æ®ä¸€èˆ¬ç”±å†…ç½®å‡½æ•°æˆ–è€…åº“å¼€å‘è€…æä¾›çš„æ¨¡å—å‡½æ•°ç”Ÿæˆã€‚

```javascript
var my_new_obj=func(){
    return __builtin_my_obj();
}
var obj=my_new_obj();
```

### __è¿ç®—ç¬¦__

nasalæ‹¥æœ‰åŸºæœ¬çš„å››ç§æ•°å­¦è¿ç®—ç¬¦ `+` `-` `*` `/`ä»¥åŠä¸€ä¸ªç‰¹åˆ«çš„è¿ç®—ç¬¦ `~`ï¼Œè¿™ä¸ªè¿ç®—ç¬¦ç”¨äºæ‹¼æ¥ä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚

```javascript
1+2-1*2/1;
'str1'~'str2';
(1+2)*(3+4)
```

å¯¹äºæ¡ä»¶è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨`==` `!=` `<` `>` `<=` `>=`æ¥æ¯”è¾ƒä¸¤ä¸ªæ•°æ®ã€‚`and` `or` æœ‰ç€ä¸C/C++ä¸­ `&&` `||`è¿ç®—ç¬¦ç›¸åŒçš„åŠŸèƒ½ï¼Œç”¨äºè¿æ¥ä¸¤ä¸ªä¸åŒçš„æ¡ä»¶è¯­å¥ã€‚

```javascript
1+1 and 0;
1<0 or 1>0;
1<=0 and 1>=0;
1==0 or 1!=0;
```

å•ç›®è¿ç®—ç¬¦`-` `!`ä¸C/C++ä¸­çš„è¿ç®—ç¬¦åŠŸèƒ½ç±»ä¼¼.

```javascript
-1;
!0;
```

èµ‹å€¼è¿ç®—ç¬¦`=` `+=` `-=` `*=` `/=` `~=`æ­£å¦‚å…¶åï¼Œç”¨äºè¿›è¡Œèµ‹å€¼ã€‚

```javascript
a=b=c=d=1;
a+=1;
a-=1;
a*=1;
a/=1;
a~='string';
```

### __å®šä¹‰å˜é‡__

```javascript
var a=1;
var (a,b,c)=[0,1,2];
var (a,b,c)=(0,1,2);
(var a,b,c)=[0,1,2];
(var a,b,c)=(0,1,2);
```

### __å¤šå˜é‡èµ‹å€¼__

æœ€åè¿™ä¸ªè¯­å¥é€šå¸¸ç”¨äºäº¤æ¢ä¸¤ä¸ªå˜é‡çš„æ•°æ®ï¼Œç±»ä¼¼äºPythonä¸­çš„æ“ä½œã€‚

```javascript
(a,b[0],c.d)=[0,1,2];
(a,b[1],c.e)=(0,1,2);
(a,b)=(b,a);
```

### __æ¡ä»¶è¯­å¥__

nasalåœ¨æä¾›`else if`çš„åŒæ—¶è¿˜æœ‰å¦å¤–ä¸€ä¸ªå…³é”®å­—`elsif`ã€‚è¯¥å…³é”®å­—ä¸`else if`æœ‰ç›¸åŒçš„åŠŸèƒ½ã€‚

```javascript
if(1){
    ;
}elsif(2){
    ;
}else if(3){
    ;
}else{
    ;
}
```

### __å¾ªç¯è¯­å¥__

whileå¾ªç¯å’Œforå¾ªç¯å¤§ä½“ä¸Šä¸C/C++æ˜¯ä¸€è‡´çš„ã€‚

```javascript
while(condition)
    continue;

for(var i=0;i<10;i+=1)
    break;
```

åŒæ—¶ï¼Œnasalè¿˜æœ‰å¦å¤–ä¸¤ç§ç›´æ¥éå†åˆ—è¡¨çš„å¾ªç¯æ–¹å¼:

`forindex` ä¼šè·å–åˆ—è¡¨çš„ä¸‹æ ‡ï¼Œä¾æ¬¡é€’å¢. ä¸‹æ ‡ä¼šä»`0`é€’å¢åˆ°`size(elem)-1`ç»“æŸã€‚

```javascript
forindex(var i;elem)
    print(elem[i]);
```

`foreach`ä¼šä¾æ¬¡ç›´æ¥è·å–åˆ—è¡¨ä¸­çš„æ•°æ®. è¿™äº›æ•°æ®ä¼šä»`elem[0]`ä¾æ¬¡è·å–åˆ°`elem[size(elem)-1]`.

```javascript
foreach(var i;elem)
    print(i);
```

### __ç”Ÿæˆå­åˆ—è¡¨__

nasalæä¾›äº†ä¸‹é¢ç¬¬ä¸€å¥çš„ç±»ä¼¼è¯­æ³•æ¥ä»åˆ—è¡¨ä¸­éšæœºæˆ–è€…æŒ‰ç…§ä¸€ä¸ªåŒºé—´è·å–æ•°æ®ï¼Œå¹¶ä¸”æ‹¼æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ—è¡¨ã€‚å½“ç„¶å¦‚æœä¸­æ‹¬å·å†…åªæœ‰ä¸€ä¸ªä¸‹æ ‡çš„è¯ï¼Œä½ ä¼šç›´æ¥è·å¾—è¿™ä¸ªä¸‹æ ‡å¯¹åº”çš„æ•°æ®è€Œä¸æ˜¯ä¸€ä¸ªå­åˆ—è¡¨ã€‚å¦‚æœç›´æ¥å¯¹stringä½¿ç”¨ä¸‹æ ‡æ¥è·å–å†…å®¹çš„è¯ï¼Œä¼šå¾—åˆ°å¯¹åº”å­—ç¬¦çš„ __asciiå€¼__ã€‚å¦‚æœä½ æƒ³è¿›ä¸€æ­¥è·å¾—è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å†…ç½®å‡½æ•°`chr()`ã€‚

```javascript
a[0];
a[-1,1,0:2,0:,:3,:,nil:8,3:nil,nil:nil];
"hello world"[0];
```

### __ç‰¹æ®Šå‡½æ•°è°ƒç”¨è¯­æ³•__

è¿™ç§ç‰¹åˆ«çš„è°ƒç”¨æ–¹å¼æœ‰æ—¶éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯åˆ‡è®°è¿™ç§è°ƒç”¨æ–¹å¼ä¸æ˜¯å¾ˆé«˜æ•ˆï¼Œå› ä¸ºå“ˆå¸Œè¡¨ä¼šä½¿ç”¨å­—ç¬¦ä¸²æ¯”å¯¹æ¥æ‰¾åˆ°æ•°æ®å­˜æ”¾çš„ä½ç½®ã€‚

```javascript
f(x:0,y:nil,z:[]);
```

### __lambdaè¡¨è¾¾å¼__

æ­£å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œå‡½æ•°æœ‰è¿™æ ·ä¸€ç§ç›´æ¥ç¼–å†™å‡½æ•°ä½“å¹¶ä¸”ç›´æ¥è°ƒç”¨çš„æ–¹å¼:

```javascript
func(x,y){return x+y}(0,1);
func(x){return 1/(1+math.exp(-x));}(0.5);
```

æµ‹è¯•æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªéå¸¸æœ‰è¶£çš„æ–‡ä»¶`y-combinator.nas`ï¼Œä¹Ÿå°±æ˜¯yç»„åˆå­ï¼Œå¯ä»¥è¯•ä¸€è¯•ï¼Œéå¸¸æœ‰è¶£:

```javascript
var fib=func(f){
    return f(f);
}(
    func(f){
        return func(x){
            if(x<2) return x;
            return f(f)(x-1)+f(f)(x-2);
        }
    }
);
```

### __é—­åŒ…__

é—­åŒ…æ˜¯ä¸€ç§ç‰¹åˆ«çš„ä½œç”¨åŸŸï¼Œä½ å¯ä»¥ä»è¿™ä¸ªä½œç”¨åŸŸä¸­è·å–å…¶ä¿å­˜çš„æ‰€æœ‰å˜é‡ï¼Œè€Œè¿™äº›å˜é‡åŸæœ¬ä¸æ˜¯ä½ å½“å‰è¿è¡Œçš„å‡½æ•°çš„å±€éƒ¨ä½œç”¨åŸŸä¸­çš„ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­é‡Œï¼Œç»“æœæ˜¯`1`:

```javascript
var f=func(){
    var a=1;
    return func(){return a;};
}
print(f()());
```

å¦‚æœå–„ç”¨é—­åŒ…ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡Œé¢å‘å¯¹è±¡ç¼–ç¨‹ã€‚

```javascript
var student=func(n,a){
    var (name,age)=(n,a);
    return {
        print_info:func() {println(name,' ',age);},
        set_age:   func(a){age=a;},
        get_age:   func() {return age;},
        set_name:  func(n){name=n;},
        get_name:  func() {return name;}
    };
}
```

### __ç‰¹æ€§__

å½“ç„¶ï¼Œä¹Ÿæœ‰å¦å¤–ä¸€ç§åŠæ³•æ¥é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé‚£å°±æ˜¯åˆ©ç”¨`trait`ã€‚

å½“ä¸€ä¸ªhashç±»å‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæˆå‘˜çš„keyæ˜¯`parents`ï¼Œå¹¶ä¸”è¯¥æˆå‘˜æ˜¯ä¸€ä¸ªæ•°ç»„çš„è¯ï¼Œé‚£ä¹ˆå½“ä½ è¯•å›¾ä»è¿™ä¸ªhashä¸­å¯»æ‰¾ä¸€ä¸ªå®ƒè‡ªå·±æ²¡æœ‰çš„æˆå‘˜åæ—¶ï¼Œè™šæ‹Ÿæœºä¼šè¿›ä¸€æ­¥æœç´¢`parents`æ•°ç»„ã€‚
å¦‚æœè¯¥æ•°ç»„ä¸­æœ‰ä¸€ä¸ªhashç±»å‹ï¼Œæœ‰ä¸€ä¸ªæˆå‘˜çš„keyä¸å½“å‰ä½ æœç´¢çš„æˆå‘˜åä¸€è‡´ï¼Œé‚£ä¹ˆä½ ä¼šå¾—åˆ°è¿™ä¸ªæˆå‘˜å¯¹åº”çš„å€¼ã€‚

ä½¿ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œä¸‹é¢æ ·ä¾‹çš„ç»“æœæ˜¯`114514`:

```javascript
var trait={
    get:func{return me.val;},
    set:func(x){me.val=x;}
};

var class={
    new:func(){
        return {
            val:nil,
            parents:[trait]
        };
    }
};
var a=class.new();
a.set(114514);
println(a.get());
```

é¦–å…ˆè™šæ‹Ÿæœºä¼šå‘ç°åœ¨`a`ä¸­æ‰¾ä¸åˆ°æˆå‘˜`set`ï¼Œä½†æ˜¯åœ¨`a.parents`ä¸­æœ‰ä¸ªhashç±»å‹`trait`å­˜åœ¨è¯¥æˆå‘˜ï¼Œæ‰€ä»¥è¿”å›äº†è¿™ä¸ªæˆå‘˜çš„å€¼ã€‚
æˆå‘˜`me`æŒ‡å‘çš„æ˜¯`a`è‡ªèº«ï¼Œç±»ä¼¼äºä¸€äº›è¯­è¨€ä¸­çš„`this`ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œå®é™…ä¸Šä¿®æ”¹äº†`a.val`ã€‚`get`å‡½æ•°çš„è°ƒç”¨å®é™…ä¸Šä¹Ÿç»è¿‡äº†ç›¸åŒçš„è¿‡ç¨‹ã€‚

ä¸è¿‡æˆ‘ä»¬å¿…é¡»æé†’ä½ ä¸€ç‚¹ï¼Œå¦‚æœä½ åœ¨è¿™ä¸ªåœ°æ–¹ä½¿ç”¨è¯¥ä¼˜åŒ–æ¥å‡å°‘hashçš„æœç´¢å¼€é”€:

```javascript
var trait={
    get:func{return me.val;},
    set:func(x){me.val=x;}
};

var class={
    new:func(){
        return {
            val:nil,
            parents:[trait]
        };
    }
};
var a=class.new();
var b=class.new();
a.set(114);
b.set(514);
println(a.get());
println(b.get());

var c=a.get;
var d=b.get;

println(c());
println(c());
println(d());
println(d());
```

é‚£ä¹ˆä½ ä¼šå‘ç°ç°åœ¨è™šæ‹Ÿæœºä¼šè¾“å‡ºè¿™ä¸ªç»“æœ:

```bash
114
514
514
514
514
514
```

å› ä¸ºæ‰§è¡Œ`a.get`æ—¶åœ¨`trait.get`å‡½æ•°çš„å±æ€§ä¸­è¿›è¡Œäº†`me=a`çš„æ“ä½œã€‚è€Œ`b.get`åˆ™æ‰§è¡Œäº†`me=b`çš„æ“ä½œã€‚æ‰€ä»¥åœ¨è¿è¡Œ`var d=b.get`åå®é™…ä¸Šcä¹Ÿå˜æˆ`b.get`äº†ã€‚
å¦‚æœä½ æƒ³è¦ç”¨è¿™ç§å°æŠ€å·§æ¥è®©ç¨‹åºè¿è¡Œæ›´é«˜æ•ˆçš„è¯ï¼Œæœ€å¥½æ˜¯è¦çŸ¥é“è¿™é‡Œå­˜åœ¨è¿™æ ·ä¸€ä¸ªæœºåˆ¶ã€‚

### __å†…ç½®å‡½æ•°__

è¿™ä¸ªéƒ¨åˆ†å¯¹äºçº¯ç²¹çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯ä¸éœ€è¦äº†è§£çš„ï¼Œå®ƒå°†å‘Šè¯‰ä½ æˆ‘ä»¬æ˜¯å¦‚ä½•ä¸ºè¿™ä¸ªè§£é‡Šå™¨æ·»åŠ æ–°çš„å†…ç½®å‡½æ•°çš„ã€‚å¦‚æœä½ å¯¹äºæ·»åŠ è‡ªå·±ç§äººè®¢åˆ¶çš„å†…ç½®å‡½æ•°å¾ˆæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆè¿™ä¸ªéƒ¨åˆ†å¯èƒ½ä¼šå¸®åˆ°ä½ ï¼Œå¹¶ä¸”â€¦â€¦

__è­¦å‘Š:__ å¦‚æœä½  __ä¸æƒ³__ é€šè¿‡ç›´æ¥ä¿®æ”¹è§£é‡Šå™¨æºç æ¥æ·»åŠ ä½ è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œé‚£ä¹ˆä½ åº”è¯¥çœ‹ä¸‹ä¸€ä¸ªéƒ¨åˆ† __`æ¨¡å—`__ çš„å†…å®¹ï¼Œè€Œä¸æ˜¯è¿™ä¸ªéƒ¨åˆ†çš„å†…å®¹ã€‚

å¦‚æœä½ ç¡®å®æ˜¯æƒ³ä¿®æ”¹æºç æ¥æä¸€ä¸ªè‡ªå·±ç§äººè®¢åˆ¶çš„è§£é‡Šå™¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¯´ï¼šâ€œæˆ‘ä»–å¦ˆå°±æ˜¯æƒ³è‡ªå·±ç§äººè®¢åˆ¶ï¼Œä½ ä»¬ä»–å¦ˆçš„ç®¡å¾—ç€å—â€ï¼Œç„¶åçœ‹çœ‹æºç ä¸­å…³äºå†…ç½®å‡½æ•°çš„éƒ¨åˆ†ï¼Œä»¥åŠ`lib.nas`ä¸­æ˜¯å¦‚ä½•åŒ…è£…è¿™äº›å‡½æ•°çš„ï¼Œè¿˜æœ‰ä¸‹é¢çš„æ ·ä¾‹:

å®šä¹‰æ–°çš„å†…ç½®å‡½æ•°:

```C++
nasal_ref builtin_print(nasal_ref*,nasal_gc&);
// ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå®æ¥ç›´æ¥å®šä¹‰ä¸€ä¸ªæ–°çš„å†…ç½®å‡½æ•°
nas_native(builtin_print);
```

ç„¶åç”¨C++å®Œæˆè¿™ä¸ªå‡½æ•°çš„å‡½æ•°ä½“:

```C++
nasal_ref builtin_print(nasal_ref* local,nasal_gc& gc)
{
    // å±€éƒ¨å˜é‡çš„ä¸‹æ ‡å…¶å®æ˜¯ä»1å¼€å§‹çš„
    // å› ä¸ºlocal[0]æ˜¯ä¿ç•™ç»™'me'çš„ç©ºé—´
    nasal_ref vec=local[1];
    // ä¸»è¦éƒ¨åˆ†
    // ä¸€äº›å¿…è¦çš„ç±»å‹æ£€æŸ¥å’Œè¾“å…¥åˆæ³•æ€§æ£€æµ‹ä¹Ÿè¦åœ¨è¿™é‡Œå†™å‡º
    // å¦‚æœæ£€æµ‹åˆ°é—®é¢˜ï¼Œç”¨builtin_errå‡½æ•°æ¥è¿”å›vm_null
    // å¹¶ä¸”ç‹ ç‹ åœ°éª‚é‚£äº›ä¸å¥½å¥½å†™ä»£ç çš„æ··è›‹(ç©ç¬‘)
    for(auto& i:vec.vec().elems)
        switch(i.type)
        {
            case vm_none: std::cout<<"undefined";      break;
            case vm_nil:  std::cout<<"nil";            break;
            case vm_num:  std::cout<<i.num();          break;
            case vm_str:  std::cout<<i.str();          break;
            case vm_vec:  i.vec().print();             break;
            case vm_hash: i.hash().print();            break;
            case vm_func: std::cout<<"func(...){...}"; break;
            case vm_obj:  std::cout<<"<object>";       break;
        }
    std::cout<<std::flush;
    // æœ€åä¸€å®šè¦è®°å¾—ç”Ÿæˆè¿”å›å€¼,è¿”å›å€¼å¿…é¡»æ˜¯ä¸€ä¸ªå†…ç½®çš„ç±»å‹ï¼Œ
    // å¯ä»¥ä½¿ç”¨gc::alloc(type)æ¥ç”³è¯·ä¸€ä¸ªéœ€è¦å†…å­˜ç®¡ç†çš„å¤æ‚æ•°æ®ç»“æ„
    // æˆ–è€…ç”¨æˆ‘ä»¬å·²ç»å®šä¹‰å¥½çš„nil/one/zeroï¼Œè¿™äº›å¯ä»¥ç›´æ¥ä½¿ç”¨
    return nil;
}
```

è¿™äº›å·¥ä½œéƒ½å®Œæˆä¹‹åï¼Œåœ¨å†…ç½®å‡½æ•°æ³¨å†Œè¡¨ä¸­å¡«å†™å®ƒåœ¨nasalä¸­çš„åˆ«åï¼Œå¹¶ä¸”åœ¨è¡¨ä¸­å¡«å¯¹è¿™ä¸ªå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ:

```C++
struct func
{
    const char* name;
    nasal_ref (*func)(nasal_ref*,nasal_gc&);
} builtin[]=
{
    {"__builtin_print",builtin_print},
    {nullptr,          nullptr      }
};
```

æœ€åï¼Œå°†å…¶åŒ…è£…èµ·æ¥æ‰”åˆ°nasalæ–‡ä»¶ä¸­:

```javascript
var print=func(elems...){
    return __builtin_print(elems);
};
```

äº‹å®ä¸Š`__builtin_print`åé¢è·Ÿç€çš„ä¼ å‚åˆ—è¡¨ä¸æ˜¯å¿…é¡»è¦å†™çš„ã€‚æ‰€ä»¥è¿™æ ·å†™ä¹Ÿå¯¹:

```javascript
var print=func(elems...){
    return __builtin_print;
};
```

ä¸€å®šè¦æ³¨æ„ï¼Œå¦‚æœä½ ä¸æŠŠå†…ç½®å‡½æ•°åŒ…è£…åˆ°ä¸€ä¸ªæ™®é€šçš„nasalå‡½æ•°ä¸­ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨è¿™ä¸ªå†…ç½®å‡½æ•°ä¼šåœ¨å‚æ•°ä¼ å…¥é˜¶æ®µå‡ºç°ä¸¥é‡çš„é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯ä¼šå¯¼è‡´ __segmentation error__ã€‚ä¹Ÿå°±æ˜¯å¤§å®¶çš„è€æœ‹å‹æ®µé”™è¯¯ã€‚

åœ¨nasalæ–‡ä»¶ä¸­ä½¿ç”¨`import("æ–‡ä»¶å.nas")`å¯ä»¥å¯¼å…¥è¯¥æ–‡ä»¶ä¸­ä½ åŒ…è£…çš„æ‰€æœ‰å†…ç½®å‡½æ•°ï¼Œæ¥ä¸‹æ¥ä½ å°±å¯ä»¥ä½¿ç”¨ä»–ä»¬äº†ã€‚
å½“ç„¶ä¹Ÿæœ‰å¦å¤–ä¸€ç§åŠæ³•æ¥å¯¼å…¥è¿™äº›nasalæ–‡ä»¶ï¼Œä¸‹é¢ä¸¤ç§å¯¼å…¥æ–¹å¼çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š

```javascript
import.dirname.dirname.filename;
import("./dirname/dirname/filename.nas");
```

å½“è¿è¡Œå†…ç½®å‡½æ•°çš„æ—¶å€™ï¼Œå†…å­˜åˆ†é…å™¨å¦‚æœè¿è¡Œè¶…è¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆä¼šæœ‰æ›´å¤§å¯èƒ½æ€§å¤šæ¬¡è§¦å‘åƒåœ¾æ”¶é›†å™¨çš„mark-sweepã€‚è¿™ä¸ªæ“ä½œä¼šåœ¨`gc::alloc`ä¸­è§¦å‘ã€‚
å¦‚æœå…ˆå‰è·å–çš„æ•°å€¼æ²¡æœ‰è¢«æ­£ç¡®å­˜åˆ°å¯ä»¥è¢«åƒåœ¾æ”¶é›†å™¨ç´¢å¼•åˆ°çš„åœ°æ–¹ï¼Œé‚£ä¹ˆå®ƒä¼šè¢«é”™è¯¯åœ°å›æ”¶ï¼Œè¿™ä¼šå¯¼è‡´ä¸¥é‡çš„é”™è¯¯ã€‚

æ‰€ä»¥è¯·ä½¿ç”¨`gc::temp`æ¥æš‚æ—¶å­˜å‚¨ä¸€ä¸ªä¼šè¢«è¿”å›çš„éœ€è¦gcç®¡ç†çš„å˜é‡ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å†…éƒ¨æ‰€æœ‰çš„ç”³è¯·é”™è¯¯è§¦å‘åƒåœ¾å›æ”¶ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```C++
nasal_ref builtin_keys(nasal_ref* local,nasal_gc& gc)
{
    nasal_ref hash=local[1];
    if(hash.type!=vm_hash)
        return builtin_err("keys","\"hash\" must be hash");
    // ä½¿ç”¨gc.tempæ¥å­˜å‚¨gcç®¡ç†çš„å˜é‡ï¼Œé˜²æ­¢é”™è¯¯çš„å›æ”¶
    nasal_ref res=gc.temp=gc.alloc(vm_vec);
    auto& vec=res.vec().elems;
    for(auto& iter:hash.hash().elems)
        vec.push_back(gc.newstr(iter.first));
    gc.temp=nil;
    return res;
}
```

### __æ¨¡å—(å¼€å‘è€…æ•™ç¨‹)__

å¦‚æœåªæœ‰ä¸Šæ–‡ä¸­é‚£ç§æ–¹å¼æ¥æ·»åŠ ä½ è‡ªå®šä¹‰çš„å‡½æ•°åˆ°nasalä¸­ï¼Œè¿™è‚¯å®šæ˜¯éå¸¸éº»çƒ¦çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ç»„å®ç”¨çš„å†…ç½®å‡½æ•°æ¥å¸®åŠ©ä½ æ·»åŠ ä½ è‡ªå·±åˆ›å»ºçš„æ¨¡å—ã€‚

åœ¨2021/12/3æ›´æ–°åï¼Œæˆ‘ä»¬ç»™`lib.nas`æ·»åŠ äº†ä¸‹é¢çš„è¿™ä¸€æ‰¹å‡½æ•°:

```javascript
var dylib=
{
    dlopen:  func(libname){return __builtin_dlopen;},
    dlsym:   func(lib,sym){return __builtin_dlsym; },
    dlclose: func(lib){return __builtin_dlclose;   },
    dlcall:  func(funcptr,args...){return __builtin_dlcall}
};
```

çœ‹åå­—å°±å¤§æ¦‚èƒ½çŒœå‡ºæ¥ï¼Œè¿™äº›å‡½æ•°å°±æ˜¯ç”¨æ¥åŠ è½½åŠ¨æ€åº“çš„ï¼Œè¿™æ ·nasalè§£é‡Šå™¨å¯ä»¥æ ¹æ®ç”¨æˆ·éœ€æ±‚çµæ´»åŠ è½½åŠ¨æ€åº“æ¥æ‰§è¡Œã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›å‡½æ•°è¯¥å¦‚ä½•ä½¿ç”¨ã€‚

é¦–å…ˆï¼Œç”¨C++å†™ä¸ªé¡¹ç›®ï¼Œå¹¶ä¸”ç¼–è¯‘æˆåŠ¨æ€åº“ã€‚æˆ‘ä»¬å°±æ‹¿`fib.cpp`ä½œä¸ºä¾‹å­æ¥è¯´æ˜(æ ·ä¾‹ä»£ç å¯ä»¥åœ¨`./module`ä¸­æ‰¾åˆ°):

```C++
// è¿™ä¸ªå¤´æ–‡ä»¶å¾—åŠ ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ‹¿åˆ°nasalçš„api
#include "nasal.h"
double fibonaci(double x){
    if(x<=2)
        return x;
    return fibonaci(x-1)+fibonaci(x-2);
}
// è®°å¾—ç”¨extern "C"
// è¿™æ ·æ‰¾ç¬¦å·ä¼šæ›´åŠ å¿«é€Ÿä¾¿æ·ï¼Œä¸è¦åœ¨æ„ç¼–è¯‘æ—¶çš„warning
extern "C" nasal_ref fib(std::vector<nasal_ref>& args,nasal_gc& gc){
    // ä¼ å‚ä¼šè¢«é€åˆ°ä¸€ä¸ªvm_vecç±»å‹ä¸­é€è¿‡æ¥ï¼Œè€Œä¸æ˜¯ä¸Šæ–‡ä¸­é‚£ç§æŒ‡é’ˆç›´æ¥æŒ‡å‘å±€éƒ¨ä½œç”¨åŸŸ
    nasal_ref num=args[0];
    // å¦‚æœä½ æƒ³è®©è¿™ä¸ªå‡½æ•°æœ‰æ›´å¼ºçš„ç¨³å®šæ€§ï¼Œé‚£ä¹ˆä¸€å®šè¦è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥
    // builtin_errä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å›é”™è¯¯ç±»å‹è®©è™šæ‹Ÿæœºç»ˆæ­¢æ‰§è¡Œ
    if(num.type!=vm_num)
        return builtin_err("extern_fib","\"num\" must be number");
    // vm_numä½œä¸ºæ™®é€šçš„æ•°å­—ç±»å‹ï¼Œä¸æ˜¯å†…å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œæ‰€ä»¥æ— éœ€ç”³è¯·
    // å¦‚æœéœ€è¦è¿”å›å†…å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œè¯·ä½¿ç”¨gc.alloc(type)
    return {vm_num,fibonaci(num.tonum())};
}
```

æ¥ç€æˆ‘ä»¬æŠŠ`fib.cpp`ç¼–è¯‘æˆåŠ¨æ€åº“ã€‚

Linux(`.so`):

`clang++ -c -O3 fib.cpp -fPIC -o fib.o`

`clang++ -shared -o libfib.so fib.o`

Mac(`.so` & `.dylib`): å’ŒLinuxä¸‹æ“ä½œç›¸åŒã€‚

Windows(`.dll`):

`g++ -c -O3 fib.cpp -fPIC -o fib.o`

`g++ -shared -o libfib.dll fib.o`

å¥½äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæµ‹è¯•ç”¨çš„nasalä»£ç æ¥è¿è¡Œè¿™ä¸ªæ–æ³¢é‚£å¥‘å‡½æ•°äº†ã€‚ä¸‹é¢ä¾‹å­ä¸­`os.platform()`æ˜¯ç”¨æ¥æ£€æµ‹å½“å‰è¿è¡Œçš„ç³»ç»Ÿç¯å¢ƒçš„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å¯¹ä¸åŒç³»ç»Ÿè¿›è¡Œé€‚é…:

```javascript
import("lib.nas");
var dlhandle=dylib.dlopen("./module/libfib."~(os.platform()=="windows"?"dll":"so"));
var fib=dylib.dlsym(dlhandle,"fib");
for(var i=1;i<30;i+=1)
    println(dylib.dlcall(fib,i));
dylib.dlclose(dlhandle);
```

`dylib.dlopen`ç”¨äºåŠ è½½åŠ¨æ€åº“ã€‚

`dylib.dlsym`é€šè¿‡ç¬¦å·ä»åŠ¨æ€åº“ä¸­è·å¾—å‡½æ•°åœ°å€ã€‚

`dylib.dlcall`ç”¨äºè°ƒç”¨å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŠ¨æ€åº“å‡½æ•°çš„åœ°å€ï¼Œè¿™æ˜¯ä¸ªç‰¹æ®Šç±»å‹ï¼Œä¸€å®šè¦ä¿è¯è¿™ä¸ªå‚æ•°æ˜¯vm_objç±»å‹å¹¶ä¸”type=obj_externã€‚

`dylib.dlclose`ç”¨äºå¸è½½åŠ¨æ€åº“ï¼Œå½“ç„¶ï¼Œåœ¨è¿™ä¸ªå‡½æ•°è°ƒç”¨ä¹‹åï¼Œæ‰€æœ‰ä»è¯¥åº“ä¸­è·å–çš„å‡½æ•°éƒ½ä½œåºŸã€‚

å¦‚æœæ¥ä¸‹æ¥ä½ çœ‹åˆ°äº†è¿™ä¸ªè¿è¡Œç»“æœï¼Œæ­å–œä½ ï¼

```bash
./nasal a.nas
1
2 
3 
5 
8 
13
21
34
55
89
144
233
377
610
987
1597
2584
4181
6765
10946
17711
28657
46368
75025
121393
196418
317811
514229
832040
```

## __å‘è¡Œæ—¥å¿—__

### __version 8.0 release__

è¿™ä¸ªç‰ˆæœ¬çš„å‘è¡Œç‰ˆæœ‰ä¸ª __ä¸¥é‡çš„é—®é¢˜__:

in __`nasal_dbg.h:215`__: `auto canary=gc.stack+STACK_MAX_DEPTH-1;`

è¿™ä¸ªä¼šå¯¼è‡´ä¸æ­£ç¡®çš„`stackoverflow`æŠ¥é”™ã€‚å› ä¸ºå®ƒè¦†ç›–äº†åŸæœ‰çš„å˜é‡ã€‚
è¯·ä¿®æ”¹ä¸º:

`canary=gc.stack+STACK_MAX_DEPTH-1;`

å¦‚æœä¸ä¿®æ”¹è¿™ä¸€è¡Œï¼Œè°ƒè¯•å™¨è¿è¡Œè‚¯å®šæ˜¯ä¸æ­£å¸¸çš„ã€‚åœ¨`v9.0`ç¬¬ä¸€ä¸ªcommitä¸­æˆ‘ä»¬ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚

å¦å¤–ä¸€ä¸ªbugåœ¨ `nasal_err.h:class nasal_err`è¿™è¾¹ï¼Œè¦ç»™è¿™ä¸ªç±»æ·»åŠ ä¸€ä¸ªæ„é€ å‡½æ•°æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜:

```C++
    nasal_err():error(0){}
```

åŒæ ·è¿™ä¸ªä¹Ÿåœ¨`v9.0`ä¸­ä¿®å¤äº†ã€‚

## __è¯­æ³•åˆ†æ__

æœ‰ç‰¹æ®Šè¯­æ³•æ£€æŸ¥çš„`LL(1)`è¯­æ³•åˆ†æå™¨ã€‚

```javascript
(var a,b,c)=[{b:nil},[1,2],func return 0;];
(a.b,b[0],c)=(1,2,3);
```

è¿™ä¸¤ä¸ªè¡¨è¾¾å¼æœ‰åŒä¸€ä¸ªfirsté›†ï¼Œæ‰€ä»¥çº¯ç²¹çš„`LL(1)`å¾ˆéš¾å®ç°è¿™ä¸ªè¯­è¨€çš„è¯­æ³•åˆ†æã€‚æ‰€ä»¥æˆ‘ä»¬ä¸ºå…¶æ·»åŠ äº†ç‰¹æ®Šè¯­æ³•æ£€æŸ¥æœºåˆ¶ã€‚æœ¬è´¨ä¸Šè¿˜æ˜¯`LL(1)`çš„å†…æ ¸ã€‚

ä¸Šé¢è¿™ä¸ªé—®é¢˜å·²ç»è§£å†³å¾ˆä¹…äº†ï¼Œä¸è¿‡æˆ‘æœ€è¿‘å‘ç°äº†ä¸€ä¸ªæ–°çš„è¯­æ³•é—®é¢˜:

```javascript
var f=func(x,y,z){return x+y+z}
(a,b,c)=(0,1,2);
```

è¿™ç§å†™æ³•ä¼šè¢«é”™è¯¯è¯†åˆ«åˆå¹¶æˆä¸‹é¢è¿™ç§:

```javascript
var f=func(x,y,z){return x+y+z}(a,b,c)
=(0,1,2);
```

è¯­æ³•åˆ†æå™¨ä¼šè®¤ä¸ºè¿™æ˜¯ä¸ªä¸¥é‡çš„è¯­æ³•é”™è¯¯ã€‚æˆ‘åœ¨Flightgearä¸­ä¹Ÿæµ‹è¯•äº†è¿™ä¸ªä»£ç ï¼Œå®ƒå†…ç½®çš„è¯­æ³•åˆ†æå™¨ä¹Ÿè®¤ä¸ºè¿™æ˜¯é”™è¯¯è¯­æ³•ã€‚å½“ç„¶æˆ‘è®¤ä¸ºè¿™æ˜¯è¯­æ³•è®¾è®¡ä¸­çš„ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„ç¼ºæ¼ã€‚ä¸ºäº†é¿å…è¿™ä¸ªè¯­æ³•é—®é¢˜ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªåˆ†å·å°±å¯ä»¥äº†:

```javascript
var f=func(x,y,z){return x+y+z};
                               ^ å°±æ˜¯è¿™é‡Œ
(a,b,c)=(0,1,2);
```

### version 1.0 parser (last update 2019/10/14)

ç¬¬ä¸€ç‰ˆåŠŸèƒ½å®Œå¤‡çš„nasalè¯­æ³•åˆ†æå™¨å®Œæˆäº†ã€‚

åœ¨version 1.0ä¹‹å‰ï¼Œæˆ‘å¤šæ¬¡å°è¯•æ„å»ºä¸€ä¸ªæ­£ç¡®çš„è¯­æ³•åˆ†æå™¨ä½†æ˜¯æ€»å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚

æœ€ç»ˆæˆ‘å­¦ä¹ äº†`LL(1)`å’Œ`LL(k)`æ–‡æ³•å¹¶ä¸”åœ¨version 0.16(last update 2019/9/14)ä¸­å®Œæˆäº†ä¸€ä¸ªèƒ½è¯†åˆ«æ•°å­¦ç®—å¼çš„è¯­æ³•åˆ†æå™¨ã€‚

åœ¨version 0.17(2019/9/15) 0.18(2019/9/18) 0.19(2019/10/1)ä¸­æˆ‘åªæ˜¯æŠ±ç€ç©çš„å¿ƒæ€åœ¨æµ‹è¯•è¯­æ³•åˆ†æå™¨ï¼Œä¸è¿‡åœ¨é‚£ä¹‹åæˆ‘è¿˜æ˜¯å®Œæˆäº†version 1.0çš„è¯­æ³•åˆ†æå™¨ã€‚

__è¯¥é¡¹ç›®äº2019/7/25æ­£å¼å¼€å§‹__ã€‚

## __æŠ½è±¡è¯­æ³•æ ‘__

### version 1.2 ast (last update 2019/10/31)

æŠ½è±¡è¯­æ³•æ ‘åœ¨è¿™ä¸ªç‰ˆæœ¬åˆæ­¥å®Œæˆã€‚

### version 2.0 ast (last update 2020/8/31)

åœ¨è¿™ä¸ªç‰ˆæœ¬æˆ‘ä»¬åŸºäºæŠ½è±¡è¯­æ³•æ ‘å®ç°äº†ä¸€ä¸ªæ ‘è§£é‡Šå™¨ï¼Œå¹¶ä¸”å®Œæˆäº†éƒ¨åˆ†å†…ç½®å‡½æ•°ã€‚

### version 3.0 ast (last update 2020/10/23)

æˆ‘ä»¬é‡æ„äº†æŠ½è±¡è¯­æ³•æ ‘çš„ä»£ç ï¼Œç°åœ¨å¯ä»¥æ›´å®¹æ˜“åœ°è¯»æ‡‚ä»£ç å¹¶è¿›è¡Œç»´æŠ¤ã€‚

è¿™ä¸ªç‰ˆæœ¬çš„æ ‘è§£é‡Šå™¨ç”¨äº†æ–°çš„ä¼˜åŒ–æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥æ›´é«˜æ•ˆåœ°æ‰§è¡Œä»£ç ã€‚

åœ¨è¿™ä¸ªç‰ˆæœ¬ç”¨æˆ·å·²ç»å¯ä»¥è‡ªè¡Œæ·»åŠ å†…ç½®å‡½æ•°ã€‚

æˆ‘æƒ³åœ¨v4.0å‘å¸ƒä¹‹åä»ç„¶ä¿ç•™è¿™ä¸ªæ ‘è§£é‡Šå™¨ï¼Œæ¯•ç«ŸèŠ±äº†å¾ˆé•¿æ—¶é—´æ‰å†™å®Œè¿™å¨å±ã€‚

### version 5.0 ast (last update 2021/3/7)

æˆ‘æ”¹å˜æƒ³æ³•äº†ï¼Œæ ‘è§£é‡Šå™¨ç»™ç»´æŠ¤å¸¦æ¥äº†å¤ªå¤§çš„éº»çƒ¦ã€‚å¦‚æœæƒ³ç»§ç»­ä¿ç•™è¿™ä¸ªè§£é‡Šå™¨ï¼Œé‚£ä¹ˆä¸ºäº†å…¼å®¹æ€§ï¼Œå­—èŠ‚ç è™šæ‹Ÿæœºçš„ä¼˜åŒ–å·¥ä½œä¼šæ›´éš¾æ¨è¿›ã€‚

## __å­—èŠ‚ç è™šæ‹Ÿæœº__

### version 4.0 vm (last update 2020/12/17)

æˆ‘åœ¨è¿™ä¸ªç‰ˆæœ¬å®ç°äº†ç¬¬ä¸€ç‰ˆå­—èŠ‚ç è™šæ‹Ÿæœºã€‚ä¸è¿‡è¿™ä¸ªè™šæ‹Ÿæœºä»ç„¶åœ¨æµ‹è¯•ä¸­ï¼Œåœ¨è¿™æ¬¡æµ‹è¯•ç»“æŸä¹‹åï¼Œæˆ‘ä¼šå‘å¸ƒv4.0å‘è¡Œç‰ˆã€‚

ç°åœ¨æˆ‘åœ¨æ‰¾ä¸€äº›éšè—å¾ˆæ·±çš„bugã€‚å¦‚æœæœ‰äººæƒ³å¸®å¿™çš„è¯ï¼Œéå¸¸æ¬¢è¿ï¼:)

ä¸‹é¢æ˜¯ç”Ÿæˆçš„å­—èŠ‚ç çš„æ ·ä¾‹:

```javascript
for(var i=0;i<4000000;i+=1);
```

```x86asm
.number 0
.number 4e+006
.number 1
.symbol i
0x00000000: pzero  0x00000000
0x00000001: loadg  0x00000000 (i)
0x00000002: callg  0x00000000 (i)
0x00000003: pnum   0x00000001 (4e+006)
0x00000004: less   0x00000000
0x00000005: jf     0x0000000b
0x00000006: pone   0x00000000
0x00000007: mcallg 0x00000000 (i)
0x00000008: addeq  0x00000000
0x00000009: pop    0x00000000
0x0000000a: jmp    0x00000002
0x0000000b: nop    0x00000000
```

### version 5.0 vm (last update 2021/3/7)

ä»è¿™ä¸ªç‰ˆæœ¬èµ·ï¼Œæˆ‘å†³å®šæŒç»­ä¼˜åŒ–å­—èŠ‚ç è™šæ‹Ÿæœºã€‚

æ¯•ç«Ÿç°åœ¨è¿™ç©æ„ä»`0`æ•°åˆ°`4000000-1`è¦èŠ±è´¹1.5ç§’ã€‚è¿™æ•ˆç‡å®Œå…¨ä¸èƒ½å¿ã€‚

2021/1/23 update: ç°åœ¨å®ƒç¡®å®å¯ä»¥åœ¨1.5ç§’å†…ä»`0`æ•°åˆ°`4000000-1`äº†ã€‚

### version 6.0 vm (last update 2021/6/1)

ä½¿ç”¨`loadg`/`loadl`/`callg`/`calll`/`mcallg`/`mcalll`æŒ‡ä»¤æ¥å‡å°‘åˆ†æ”¯è¯­å¥çš„è°ƒç”¨ã€‚

åˆ é™¤äº†`vm_scop`ç±»å‹ã€‚

æ·»åŠ ä½œä¸ºå¸¸é‡çš„`vm_num`æ¥å‡å°‘å†…å­˜åˆ†é…çš„å¼€é”€ã€‚

å°†åƒåœ¾æ”¶é›†å™¨ä»å¼•ç”¨è®¡æ•°æ”¹ä¸ºäº†æ ‡è®°æ¸…ç†ã€‚

`vapp`å’Œ`newf`å¼€å§‹ä½¿ç”¨å…ˆå‰æœªè¢«ä½¿ç”¨çš„.numæ®µæ¥å‹ç¼©å­—èŠ‚ç ç”Ÿæˆæ•°é‡ï¼Œå‡å°‘ç”Ÿæˆçš„`exec_code`çš„å¤§å°ã€‚

2021/4/3 update: ä»`0`æ•°åˆ°`4e6-1`åªéœ€è¦ä¸åˆ°0.8ç§’äº†ã€‚

2021/4/19 update: ä»`0`æ•°åˆ°`4e6-1`åªéœ€è¦ä¸åˆ°0.4ç§’äº†ã€‚

åœ¨è¿™æ¬¡çš„æ›´æ–°ä¸­ï¼Œæˆ‘æŠŠå…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡çš„å­˜å‚¨ç»“æ„ä»`unordered_map`å˜ä¸ºäº†`vector`ï¼Œä»è€Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚æ‰€ä»¥ç°åœ¨ç”Ÿæˆçš„å­—èŠ‚ç å¤§å˜æ ·äº†ã€‚

```javascript
for(var i=0;i<4000000;i+=1);
```

```x86asm
.number 4e+006
0x00000000: intg   0x00000001
0x00000001: pzero  0x00000000
0x00000002: loadg  0x00000000
0x00000003: callg  0x00000000
0x00000004: pnum   0x00000000 (4e+006)
0x00000005: less   0x00000000
0x00000006: jf     0x0000000c
0x00000007: pone   0x00000000
0x00000008: mcallg 0x00000000
0x00000009: addeq  0x00000000
0x0000000a: pop    0x00000000
0x0000000b: jmp    0x00000003
0x0000000c: nop    0x00000000
```

### version 6.5 vm (last update 2021/6/24)

2021/5/31 update:

ç°åœ¨åƒåœ¾æ”¶é›†å™¨ä¸ä¼šé”™è¯¯åœ°é‡å¤æ”¶é›†æœªä½¿ç”¨å˜é‡äº†ã€‚

æ·»åŠ äº†`builtin_alloc`ä»¥é˜²æ­¢åœ¨è¿è¡Œå†…ç½®å‡½æ•°çš„æ—¶å€™é”™è¯¯è§¦å‘æ ‡è®°æ¸…é™¤ã€‚

å»ºè®®åœ¨è·å–å¤§ç©ºé—´æ•°ç»„çš„æ—¶å€™å°½é‡ä½¿ç”¨setsizeï¼Œå› ä¸º`append`åœ¨è¢«é¢‘ç¹è°ƒç”¨æ—¶å¯èƒ½ä¼šé¢‘ç¹è§¦å‘åƒåœ¾æ”¶é›†å™¨ã€‚

2021/6/3 update:

ä¿®å¤äº†åƒåœ¾æ”¶é›†å™¨è¿˜æ˜¯ä»–å¦ˆçš„ä¼šé‡å¤æ”¶é›†çš„bugï¼Œè¿™æ¬¡æˆ‘è®¾è®¡äº†ä¸‰ä¸ªæ ‡è®°çŠ¶æ€æ¥ä¿è¯åƒåœ¾æ˜¯è¢«æ­£ç¡®æ”¶é›†äº†ã€‚

å°†`callf`æŒ‡ä»¤æ‹†åˆ†ä¸º`callfv`å’Œ`callfh`ã€‚å¹¶ä¸”`callfv`å°†ç›´æ¥ä»`val_stack`è·å–ä¼ å‚ï¼Œè€Œä¸æ˜¯å…ˆé€šè¿‡ä¸€ä¸ª`vm_vec`æŠŠå‚æ•°æ”¶é›†èµ·æ¥å†ä¼ å…¥ï¼Œåè€…æ˜¯éå¸¸ä½æ•ˆçš„åšæ³•ã€‚

å»ºè®®æ›´å¤šä½¿ç”¨`callfv`è€Œä¸æ˜¯`callfh`ï¼Œå› ä¸º`callfh`åªèƒ½ä»æ ˆä¸Šè·å–å‚æ•°å¹¶æ•´åˆä¸º`vm_hash`ä¹‹åæ‰èƒ½ä¼ ç»™è¯¥æŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œæ‹–æ…¢æ‰§è¡Œé€Ÿåº¦ã€‚

```javascript
var f=func(x,y){return x+y;}
f(1024,2048);
```

```x86asm
.number 1024
.number 2048
.symbol x   
.symbol y
0x00000000: intg   0x00000001
0x00000001: newf   0x00000007
0x00000002: intl   0x00000003
0x00000003: offset 0x00000001
0x00000004: para   0x00000000 (x)
0x00000005: para   0x00000001 (y)
0x00000006: jmp    0x0000000b
0x00000007: calll  0x00000001
0x00000008: calll  0x00000002
0x00000009: add    0x00000000
0x0000000a: ret    0x00000000
0x0000000b: loadg  0x00000000
0x0000000c: callg  0x00000000
0x0000000d: pnum   0x00000000 (1024)
0x0000000e: pnum   0x00000001 (2048)
0x0000000f: callfv 0x00000002
0x00000010: pop    0x00000000
0x00000011: nop    0x00000000
```

2021/6/21 update:

ç°åœ¨åƒåœ¾æ”¶é›†å™¨ä¸ä¼šæ”¶é›†ç©ºæŒ‡é’ˆäº†ã€‚å¹¶ä¸”è°ƒç”¨é“¾ä¸­å«æœ‰å‡½æ•°è°ƒç”¨çš„èµ‹å€¼è¯­å¥ç°åœ¨ä¹Ÿå¯ä»¥æ‰§è¡Œäº†ï¼Œä¸‹é¢è¿™äº›èµ‹å€¼æ–¹å¼æ˜¯åˆæ³•çš„:

```javascript
var f=func()
{
    var _=[{_:0},{_:1}];
    return func(x)
    {
        return _[x];
    }
}
var m=f();
m(0)._=m(1)._=10;

[0,1,2][1:2][0]=0;
```

åœ¨è€ç‰ˆæœ¬ä¸­ï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ£€æŸ¥å·¦å€¼ï¼Œå¹¶ä¸”åœ¨æ£€æµ‹åˆ°æœ‰ç‰¹åˆ«è°ƒç”¨çš„æƒ…å†µä¸‹ç›´æ¥å‘ŠçŸ¥ç”¨æˆ·è¿™ç§å·¦å€¼æ˜¯ä¸è¢«æ¥å—çš„(bad lvalue)ã€‚ä½†æ˜¯ç°åœ¨å®ƒå¯ä»¥æ­£å¸¸è¿ä½œäº†ã€‚ä¸ºäº†ä¿è¯è¿™ç§èµ‹å€¼è¯­å¥èƒ½æ­£å¸¸æ‰§è¡Œï¼Œcodegenæ¨¡å—ä¼šä¼˜å…ˆä½¿ç”¨`nasal_codegen::call_gen()`ç”Ÿæˆå‰é¢è°ƒç”¨é“¾çš„å­—èŠ‚ç è€Œä¸æ˜¯å…¨éƒ¨ä½¿ç”¨ `nasal_codegen::mcall_gen()`ï¼Œåœ¨æœ€åä¸€ä¸ªè°ƒç”¨å¤„æ‰ä¼šä½¿ç”¨`nasal_codegen::mcall_gen()`ã€‚

æ‰€ä»¥ç°åœ¨ç”Ÿæˆçš„ç›¸å…³å­—èŠ‚ç ä¹Ÿå®Œå…¨ä¸åŒäº†:

```x86asm
.number 10
.number 2
.symbol _
.symbol x
0x00000000: intg   0x00000002
0x00000001: newf   0x00000005
0x00000002: intl   0x00000002
0x00000003: offset 0x00000001
0x00000004: jmp    0x00000017
0x00000005: newh   0x00000000
0x00000006: pzero  0x00000000
0x00000007: happ   0x00000000 (_)
0x00000008: newh   0x00000000
0x00000009: pone   0x00000000
0x0000000a: happ   0x00000000 (_)
0x0000000b: newv   0x00000002
0x0000000c: loadl  0x00000001
0x0000000d: newf   0x00000012
0x0000000e: intl   0x00000003
0x0000000f: offset 0x00000002
0x00000010: para   0x00000001 (x)
0x00000011: jmp    0x00000016
0x00000012: calll  0x00000001
0x00000013: calll  0x00000002
0x00000014: callv  0x00000000
0x00000015: ret    0x00000000
0x00000016: ret    0x00000000
0x00000017: loadg  0x00000000
0x00000018: callg  0x00000000
0x00000019: callfv 0x00000000
0x0000001a: loadg  0x00000001
0x0000001b: pnum   0x00000000 (10.000000)
0x0000001c: callg  0x00000001
0x0000001d: pone   0x00000000
0x0000001e: callfv 0x00000001
0x0000001f: mcallh 0x00000000 (_)
0x00000020: meq    0x00000000
0x00000021: callg  0x00000001
0x00000022: pzero  0x00000000
0x00000023: callfv 0x00000001
0x00000024: mcallh 0x00000000 (_)
0x00000025: meq    0x00000000
0x00000026: pop    0x00000000
0x00000027: pzero  0x00000000
0x00000028: pzero  0x00000000
0x00000029: pone   0x00000000
0x0000002a: pnum   0x00000001 (2.000000)
0x0000002b: newv   0x00000003
0x0000002c: slcbeg 0x00000000
0x0000002d: pone   0x00000000
0x0000002e: pnum   0x00000001 (2.000000)
0x0000002f: slc2   0x00000000
0x00000030: slcend 0x00000000
0x00000031: pzero  0x00000000
0x00000032: mcallv 0x00000000
0x00000033: meq    0x00000000
0x00000034: pop    0x00000000
0x00000035: nop    0x00000000
```

ä»ä¸Šé¢è¿™äº›å­—èŠ‚ç å¯ä»¥çœ‹å‡ºï¼Œ`mcall`/`mcallv`/`mcallh`æŒ‡ä»¤çš„ä½¿ç”¨é¢‘ç‡æ¯”ä»¥å‰å‡å°äº†ä¸€äº›ï¼Œè€Œ`call`/`callv`/`callh`/`callfv`/`callfh`åˆ™ç›¸åã€‚

å¹¶ä¸”å› ä¸ºæ–°çš„æ•°æ®ç»“æ„ï¼Œ`mcall`æŒ‡ä»¤ä»¥åŠ`addr_stack`ï¼Œä¸€ä¸ªæ›¾ç”¨æ¥å­˜å‚¨æŒ‡é’ˆçš„æ ˆï¼Œä»`nasal_vm`ä¸­è¢«ç§»é™¤ã€‚ç°åœ¨`nasal_vm`ä½¿ç”¨`nasal_val** mem_addr`æ¥æš‚å­˜è·å–çš„å†…å­˜åœ°å€ã€‚è¿™ä¸ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ï¼Œå› ä¸ºå†…å­˜ç©ºé—´æ˜¯ __è·å–å³ä½¿ç”¨__ çš„ã€‚

### version 7.0 vm (last update 2021/10/8)

2021/6/26 update:

æŒ‡ä»¤åˆ†æ´¾æ–¹å¼ä»call-threadingæ”¹ä¸ºäº†computed-gotoã€‚åœ¨æ›´æ”¹äº†æŒ‡ä»¤åˆ†æ´¾æ–¹å¼ä¹‹åï¼Œnasal_vmçš„æ‰§è¡Œæ•ˆç‡æœ‰äº†éå¸¸å·¨å¤§çš„æå‡ã€‚ç°åœ¨è™šæ‹Ÿæœºå¯ä»¥åœ¨0.2ç§’å†…æ‰§è¡Œå®Œtest/bigloopå’Œtest/piï¼å¹¶ä¸”åœ¨linuxå¹³å°è™šæ‹Ÿæœºå¯ä»¥åœ¨0.8ç§’å†…æ‰§è¡Œå®Œtest/fibã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„æµ‹è¯•æ•°æ®éƒ¨åˆ†çœ‹åˆ°æµ‹è¯•çš„ç»“æœã€‚

è¿™ä¸ªåˆ†æ´¾æ–¹å¼ä½¿ç”¨äº†g++æ‰©å±•"labels as values"ï¼Œclang++ç›®å‰ä¹Ÿæ”¯æŒè¿™ç§æŒ‡ä»¤åˆ†æ´¾çš„å®ç°æ–¹å¼ã€‚(ä¸è¿‡MSVCæ”¯ä¸æ”¯æŒå°±ä¸å¾—è€ŒçŸ¥äº†ï¼Œå“ˆå“ˆ)

nasal_gcä¸­ä¹Ÿæœ‰éƒ¨åˆ†æ”¹åŠ¨:
å…¨å±€å˜é‡ä¸å†ç”¨`std::vector`å­˜å‚¨ï¼Œè€Œæ˜¯å…¨éƒ¨å­˜åœ¨æ“ä½œæ•°æ ˆä¸Š(ä»`val_stack+0`åˆ°`val_stack+intg-1`)ã€‚

2021/6/29 update:

æ·»åŠ äº†ä¸€äº›ç›´æ¥ç”¨å¸¸é‡è¿›è¡Œè¿ç®—çš„æŒ‡ä»¤:
`op_addc`,`op_subc`,`op_mulc`,`op_divc`,`op_lnkc`,`op_addeqc`,`op_subeqc`,`op_muleqc`,`op_diveqc`,`op_lnkeqc`ã€‚

ç°åœ¨test/bigloop.nasçš„å­—èŠ‚ç æ˜¯è¿™æ ·çš„:

```x86asm
.number 4e+006
.number 1
0x00000000: intg   0x00000001
0x00000001: pzero  0x00000000
0x00000002: loadg  0x00000000
0x00000003: callg  0x00000000
0x00000004: pnum   0x00000000 (4000000)
0x00000005: less   0x00000000
0x00000006: jf     0x0000000b
0x00000007: mcallg 0x00000000
0x00000008: addeqc 0x00000001 (1)
0x00000009: pop    0x00000000
0x0000000a: jmp    0x00000003
0x0000000b: nop    0x00000000
```

åœ¨è¿™æ¬¡æ›´æ–°ä¹‹åï¼Œè¿™ä¸ªæµ‹è¯•æ–‡ä»¶å¯ä»¥åœ¨0.1ç§’å†…è¿è¡Œç»“æŸã€‚å¤§å¤šæ•°çš„è¿ç®—æ“ä½œé€Ÿåº¦éƒ½æœ‰æå‡ã€‚

å¹¶ä¸”èµ‹å€¼ç›¸å…³çš„å­—èŠ‚ç ä¹Ÿæœ‰ä¸€äº›æ”¹åŠ¨ã€‚ç°åœ¨èµ‹å€¼è¯­å¥åªåŒ…å«ä¸€ä¸ªæ ‡è¯†ç¬¦æ—¶ï¼Œä¼šä¼˜å…ˆè°ƒç”¨`op_load`æ¥èµ‹å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨`op_meq`å’Œ`op_pop`ã€‚

```javascript
var (a,b)=(1,2);
a=b=0;
```

```x86asm
.number 2
0x00000000: intg   0x00000002
0x00000001: pone   0x00000000
0x00000002: loadg  0x00000000
0x00000003: pnum   0x00000000 (2)
0x00000004: loadg  0x00000001
0x00000005: pzero  0x00000000
0x00000006: mcallg 0x00000001
0x00000007: meq    0x00000000 (b=2 use meq,pop->a)
0x00000008: loadg  0x00000000 (a=b use loadg)
0x00000009: nop    0x00000000
```

### version 8.0 vm (last update 2022/2/12)

2021/10/8 update:

ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹`vm_nil`å’Œ`vm_num`ä¸å†ç”±`nasal_gc`ç®¡ç†ï¼Œè¿™ä¼šå¤§å¹…åº¦é™ä½`gc::alloc`çš„è°ƒç”¨å¹¶ä¸”ä¼šå¤§å¹…åº¦æå‡æ‰§è¡Œæ•ˆç‡ã€‚

æ·»åŠ äº†æ–°çš„æ•°æ®ç±»å‹: `vm_obj`ã€‚è¿™ä¸ªç±»å‹æ˜¯ç•™ç»™ç”¨æˆ·å®šä¹‰ä»–ä»¬æƒ³è¦çš„æ•°æ®ç±»å‹çš„ã€‚ç›¸å…³çš„APIä¼šåœ¨æœªæ¥åŠ å…¥ã€‚

åŠŸèƒ½å®Œå¤‡çš„é—­åŒ…ï¼šæ·»åŠ äº†è¯»å†™é—­åŒ…æ•°æ®çš„æŒ‡ä»¤ã€‚åˆ é™¤äº†è€çš„æŒ‡ä»¤`op_offset`ã€‚

2021/10/13 update:

å­—èŠ‚ç ä¿¡æ¯è¾“å‡ºæ ¼å¼ä¿®æ”¹ä¸ºå¦‚ä¸‹å½¢å¼:

```x86asm
0x000002e6: newf   0x2ea
0x000002e7: intl   0x2
0x000002e8: para   0x6e ("f")
0x000002e9: jmp    0x2ee
0x000002ea: calll  0x1
0x000002eb: calll  0x1
0x000002ec: callfv 0x1
0x000002ed: ret
0x000002ee: newf   0x2f2
0x000002ef: intl   0x2
0x000002f0: para   0x6e ("f")
0x000002f1: jmp    0x30a
0x000002f2: newf   0x2f6
0x000002f3: intl   0x2
0x000002f4: para   0x3e ("x")
0x000002f5: jmp    0x309
0x000002f6: calll  0x1
0x000002f7: lessc  0x0 (2)
0x000002f8: jf     0x2fb
0x000002f9: calll  0x1
0x000002fa: ret
0x000002fb: upval  0x0[0x1]
0x000002fc: upval  0x0[0x1]
0x000002fd: callfv 0x1
0x000002fe: calll  0x1
0x000002ff: subc   0x1d (1)
0x00000300: callfv 0x1
0x00000301: upval  0x0[0x1]
0x00000302: upval  0x0[0x1]
0x00000303: callfv 0x1
0x00000304: calll  0x1
0x00000305: subc   0x0 (2)
0x00000306: callfv 0x1
0x00000307: add
0x00000308: ret
0x00000309: ret
0x0000030a: callfv 0x1
0x0000030b: loadg  0x32
```

2022/1/22 update:

åˆ é™¤`op_pone`å’Œ`op_pzero`ã€‚è¿™ä¸¤ä¸ªæŒ‡ä»¤åœ¨ç›®å‰å·²ç»æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œå¹¶ä¸”å·²ç»è¢«`op_pnum`æ›¿ä»£ã€‚

### version 9.0 vm (last update 2022/5/18)

2022/2/12 update:

å±€éƒ¨å˜é‡ç°åœ¨ä¹Ÿè¢« __å­˜å‚¨åœ¨æ ˆä¸Š__ã€‚
æ‰€ä»¥å‡½æ•°è°ƒç”¨æ¯”ä»¥å‰ä¹Ÿä¼šå¿«é€Ÿå¾ˆå¤šã€‚
åœ¨v8.0å¦‚æœä½ æƒ³è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œ
æ–°çš„`vm_vec`å°†è¢«åˆ†é…å‡ºæ¥ç”¨äºæ¨¡æ‹Ÿå±€éƒ¨ä½œç”¨åŸŸï¼Œè¿™ä¸ªæ“ä½œä¼šå¯¼è‡´æ ‡è®°æ¸…é™¤è¿‡ç¨‹ä¼šè¢«é¢‘ç¹è§¦å‘å¹¶ä¸”æµªè´¹å¤ªå¤šçš„æ‰§è¡Œæ—¶é—´ã€‚
åœ¨æµ‹è¯•æ–‡ä»¶`test/bf.nas`ä¸­ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼ä½¿å¾—å¤§éƒ¨åˆ†æ—¶é—´éƒ½è¢«æµªè´¹äº†ï¼Œå› ä¸ºè¿™ä¸ªæµ‹è¯•æ–‡ä»¶åŒ…å«å¤§é‡ä¸”é¢‘ç¹çš„å‡½æ•°è°ƒç”¨(è¯¦ç»†æ•°æ®è¯·çœ‹æµ‹è¯•æ•°æ®ä¸€èŠ‚ä¸­`version 8.0 (R9-5900HX ubuntu-WSL 2022/1/23)`)ã€‚

ç°åœ¨é—­åŒ…ä¼šåœ¨ç¬¬ä¸€æ¬¡åœ¨å±€éƒ¨ä½œç”¨åŸŸåˆ›å»ºæ–°å‡½æ•°çš„æ—¶å€™äº§ç”Ÿï¼Œä½¿ç”¨`vm_vec`ã€‚
åœ¨é‚£ä¹‹åå¦‚æœå†åˆ›å»ºæ–°çš„å‡½æ•°ï¼Œåˆ™ä»–ä»¬ä¼šå…±äº«åŒä¸€ä¸ªé—­åŒ…ï¼Œè¿™äº›é—­åŒ…ä¼šåœ¨æ¯æ¬¡äºå±€éƒ¨ä½œç”¨åŸŸåˆ›å»ºæ–°å‡½æ•°æ—¶åŒæ­¥ã€‚

2022/3/27 update:

åœ¨è¿™ä¸ªæœˆçš„æ›´æ–°ä¸­æˆ‘ä»¬æŠŠé—­åŒ…çš„æ•°æ®ç»“æ„ä»`vm_vec`æ¢æˆäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡`vm_upval`ï¼Œè¿™ç§ç±»å‹æœ‰ç€å’Œå¦å¤–ä¸€æ¬¾ç¼–ç¨‹è¯­è¨€ __`Lua`__ ä¸­é—­åŒ…ç›¸ç±»ä¼¼çš„ç»“æ„ã€‚

åŒæ—¶æˆ‘ä»¬ä¹Ÿä¿®æ”¹äº†å­—èŠ‚ç çš„è¾“å‡ºæ ¼å¼ã€‚æ–°çš„æ ¼å¼çœ‹èµ·æ¥åƒæ˜¯ `objdump`:

```x86asm
  0x0000029b:       0a 00 00 00 00        newh

func <0x29c>:
  0x0000029c:       0b 00 00 02 a0        newf    0x2a0
  0x0000029d:       02 00 00 00 02        intl    0x2
  0x0000029e:       0d 00 00 00 66        para    0x66 ("libname")
  0x0000029f:       32 00 00 02 a2        jmp     0x2a2
  0x000002a0:       40 00 00 00 42        callb   0x42 <__builtin_dlopen@0x41dc40>
  0x000002a1:       4a 00 00 00 00        ret
<0x29c>;

  0x000002a2:       0c 00 00 00 67        happ    0x67 ("dlopen")

func <0x2a3>:
  0x000002a3:       0b 00 00 02 a8        newf    0x2a8
  0x000002a4:       02 00 00 00 03        intl    0x3
  0x000002a5:       0d 00 00 00 68        para    0x68 ("lib")
  0x000002a6:       0d 00 00 00 69        para    0x69 ("sym")
  0x000002a7:       32 00 00 02 aa        jmp     0x2aa
  0x000002a8:       40 00 00 00 43        callb   0x43 <__builtin_dlsym@0x41df00>
  0x000002a9:       4a 00 00 00 00        ret
<0x2a3>;

  0x000002aa:       0c 00 00 00 6a        happ    0x6a ("dlsym")

func <0x2ab>:
  0x000002ab:       0b 00 00 02 af        newf    0x2af
  0x000002ac:       02 00 00 00 02        intl    0x2
  0x000002ad:       0d 00 00 00 68        para    0x68 ("lib")
  0x000002ae:       32 00 00 02 b1        jmp     0x2b1
  0x000002af:       40 00 00 00 44        callb   0x44 <__builtin_dlclose@0x41e2a0>
  0x000002b0:       4a 00 00 00 00        ret
<0x2ab>;

  0x000002b1:       0c 00 00 00 6b        happ    0x6b ("dlclose")

func <0x2b2>:
  0x000002b2:       0b 00 00 02 b7        newf    0x2b7
  0x000002b3:       02 00 00 00 03        intl    0x3
  0x000002b4:       0d 00 00 00 6c        para    0x6c ("funcptr")
  0x000002b5:       0f 00 00 00 6d        dyn     0x6d ("args")
  0x000002b6:       32 00 00 02 b9        jmp     0x2b9
  0x000002b7:       40 00 00 00 45        callb   0x45 <__builtin_dlcall@0x41e3d0>
  0x000002b8:       4a 00 00 00 00        ret
<0x2b2>;

  0x000002b9:       0c 00 00 00 6e        happ    0x6e ("dlcall")
  0x000002ba:       03 00 00 00 21        loadg   0x21
  0x000002bb:       0a 00 00 00 00        newh

func <0x2bc>:
  0x000002bc:       0b 00 00 02 bf        newf    0x2bf
  0x000002bd:       02 00 00 00 01        intl    0x1
  0x000002be:       32 00 00 02 c1        jmp     0x2c1
  0x000002bf:       40 00 00 00 46        callb   0x46 <__builtin_platform@0x41e4f0>
  0x000002c0:       4a 00 00 00 00        ret
<0x2bc>;

  0x000002c1:       0c 00 00 00 6f        happ    0x6f ("platform")
  0x000002c2:       03 00 00 00 22        loadg   0x22
  0x000002c3:       0a 00 00 00 00        newh

func <0x2c4>:
  0x000002c4:       0b 00 00 02 c7        newf    0x2c7
  0x000002c5:       02 00 00 00 01        intl    0x1
  0x000002c6:       32 00 00 02 c9        jmp     0x2c9
  0x000002c7:       40 00 00 00 47        callb   0x47 <__builtin_gc@0x41e530>
  0x000002c8:       4a 00 00 00 00        ret
<0x2c4>;

  0x000002c9:       0c 00 00 00 70        happ    0x70 ("gc")
  0x000002ca:       03 00 00 00 23        loadg   0x23
```

### version 10.0 vm (latest)

2022/5/19 update:

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­æˆ‘ä»¬ç»™nasalåŠ å…¥äº†åç¨‹:

```javascript
var coroutine={
    create: func(function){return __builtin_cocreate;},
    resume: func(co)      {return __builtin_coresume;},
    yield:  func(args...) {return __builtin_coyield; },
    status: func(co)      {return __builtin_costatus;},
    running:func()        {return __builtin_corun;   }
};
```

`coroutine.create`ç”¨äºåˆ›å»ºæ–°çš„åç¨‹å¯¹è±¡ã€‚ä¸è¿‡åˆ›å»ºä¹‹ååç¨‹å¹¶ä¸ä¼šç›´æ¥è¿è¡Œã€‚

`coroutine.resume`ç”¨äºç»§ç»­è¿è¡Œä¸€ä¸ªåç¨‹ã€‚

`coroutine.yield`ç”¨äºä¸­æ–­ä¸€ä¸ªåç¨‹çš„è¿è¡Œè¿‡ç¨‹å¹¶ä¸”æŠ›å‡ºä¸€äº›æ•°æ®ã€‚è¿™äº›æ•°æ®ä¼šè¢«`coroutine.resume`æ¥æ”¶å¹¶è¿”å›ã€‚è€Œåœ¨åç¨‹å‡½æ•°ä¸­`coroutine.yield`æœ¬èº«åªè¿”å›`vm_nil`ã€‚

`coroutine.status`ç”¨äºæŸ¥çœ‹åç¨‹çš„çŠ¶æ€ã€‚åç¨‹æœ‰ä¸‰ç§ä¸åŒçš„çŠ¶æ€ï¼š`suspended`æŒ‚èµ·ï¼Œ`running`è¿è¡Œä¸­ï¼Œ`dead`ç»“æŸè¿è¡Œã€‚

`coroutine.running`ç”¨äºåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰åç¨‹æ­£åœ¨è¿è¡Œã€‚

__æ³¨æ„:__ åç¨‹ä¸èƒ½åœ¨å…¶ä»–æ­£åœ¨è¿è¡Œçš„åç¨‹ä¸­åˆ›å»ºã€‚

__æ¥ä¸‹æ¥æˆ‘ä»¬è§£é‡Šè¿™ä¸ªåç¨‹çš„è¿è¡ŒåŸç†:__

å½“`op_callb`è¢«æ‰§è¡Œæ—¶ï¼Œæ ˆå¸§å¦‚ä¸‹æ‰€ç¤º:

```C++
+----------------------------+(ä¸»æ“ä½œæ•°æ ˆ)
| old pc(vm_ret)             | <- top[0]
+----------------------------+
| old localr(vm_addr)        | <- top[-1]
+----------------------------+
| old upvalr(vm_upval)       | <- top[-2]
+----------------------------+
| local scope(nasal_ref)     |
| ...                        |
+----------------------------+ <- local pointer stored in localr
| old funcr(vm_func)         | <- old function stored in funcr
+----------------------------+
```

åœ¨`op_callb`æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸‹ä¸€æ­¥çš„æ ˆå¸§å¦‚ä¸‹:

```C++
+----------------------------+(ä¸»æ“ä½œæ•°æ ˆ)
| nil(vm_nil)                | <- push nil
+----------------------------+
| old pc(vm_ret)             |
+----------------------------+
| old localr(vm_addr)        |
+----------------------------+
| old upvalr(vm_upval)       |
+----------------------------+
| local scope(nasal_ref)     |
| ...                        |
+----------------------------+ <- local pointer stored in localr
| old funcr(vm_func)         | <- old function stored in funcr
+----------------------------+
```

æ¥ç€æˆ‘ä»¬è°ƒç”¨`resume`ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ›¿æ¢æ“ä½œæ•°æ ˆã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåç¨‹çš„æ“ä½œæ•°æ ˆä¸Šå·²ç»ä¿å­˜äº†ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬é¦–æ¬¡è¿›å…¥åç¨‹æ‰§è¡Œæ—¶ï¼Œè¿™ä¸ªæ“ä½œæ•°æ ˆçš„æ ˆé¡¶å°†ä¼šæ˜¯`vm_ret`ï¼Œå¹¶ä¸”è¿”å›çš„`pc`å€¼æ˜¯`0`ã€‚

ä¸ºäº†ä¿è¯æ ˆé¡¶çš„æ•°æ®ä¸ä¼šè¢«ç ´åï¼Œ`resume`ä¼šè¿”å›`gc.top[0]`ã€‚`op_callb`å°†ä¼šæ‰§è¡Œ`top[0]=resume()`ï¼Œæ‰€ä»¥æ ˆé¡¶çš„æ•°æ®è™½ç„¶è¢«è¦†ç›–äº†ä¸€æ¬¡ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯åŸæ¥çš„æ•°æ®ã€‚

```C++
+----------------------------+(åç¨‹æ“ä½œæ•°æ ˆ)
| pc:0(vm_ret)               | <- now gc.top[0]
+----------------------------+
```

å½“æˆ‘ä»¬è°ƒç”¨`yield`çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°ä¼šæ‰§è¡Œå‡ºè¿™ä¸ªæƒ…å†µï¼Œæˆ‘ä»¬å‘ç°`op_callb` å·²ç»æŠŠ`nil`æ”¾åœ¨çš„æ ˆé¡¶ã€‚ä½†æ˜¯åº”è¯¥è¿”å›çš„`local[1]`åˆ°åº•å‘é€åˆ°å“ªé‡Œå»äº†ï¼Ÿ

```C++
+----------------------------+(åç¨‹æ“ä½œæ•°æ ˆ)
| nil(vm_nil)                | <- push nil
+----------------------------+
| old pc(vm_ret)             |
+----------------------------+
| old localr(vm_addr)        |
+----------------------------+
| old upvalr(vm_upval)       |
+----------------------------+
| local scope(nasal_ref)     |
| ...                        |
+----------------------------+ <- local pointer stored in localr
| old funcr(vm_func)         | <- old function stored in funcr
+----------------------------+
```

å½“`builtin_coyield`æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ ˆåˆåˆ‡æ¢åˆ°äº†ä¸»æ“ä½œæ•°æ ˆä¸Šï¼Œè¿™æ—¶å¯ä»¥çœ‹åˆ°è¿”å›çš„`local[1]`å®é™…ä¸Šè¢«`op_callb`æ”¾åœ¨äº†è¿™é‡Œçš„æ ˆé¡¶:

```C++
+----------------------------+(ä¸»æ“ä½œæ•°æ ˆ)
| return_value(nasal_ref)    |
+----------------------------+
| old pc(vm_ret)             |
+----------------------------+
| old localr(vm_addr)        |
+----------------------------+
| old upvalr(vm_upval)       |
+----------------------------+
| local scope(nasal_ref)     |
| ...                        |
+----------------------------+ <- local pointer stored in localr
| old funcr(vm_func)         | <- old function stored in funcr
+----------------------------+
```

æ‰€ä»¥ä¸»ç¨‹åºä¼šè®¤ä¸ºé¡¶éƒ¨è¿™ä¸ªè¿”å›å€¼å¥½åƒæ˜¯`resume`è¿”å›çš„ã€‚è€Œå®é™…ä¸Š`resume`çš„è¿”å›å€¼åœ¨åç¨‹çš„æ“ä½œæ•°æ ˆé¡¶ã€‚ç»¼ä¸Šæ‰€è¿°:

```C++
resume (main->coroutine) return coroutine.top[0]. coroutine.top[0] = coroutine.top[0];
yield  (coroutine->main) return a vector.         main.top[0]      = vector;
```

## æµ‹è¯•æ•°æ®

![benchmark](../pic/benchmark.png)

### version 6.5 (i5-8250U windows10 2021/6/19)

æ‰§è¡Œæ—¶é—´ä»¥åŠåƒåœ¾æ”¶é›†å™¨å ç”¨æ—¶é—´:

|file|call gc|total time|gc time|
|:----|:----|:----|:----|
|pi.nas|12000049|0.593s|0.222s|
|fib.nas|10573747|2.838s|0.187s|
|bp.nas|4419829|1.99s|0.18s|
|bigloop.nas|4000000|0.419s|0.039s|
|mandelbrot.nas|1044630|0.433s|0.041s|
|life.nas|817112|8.557s|0.199s|
|ascii-art.nas|45612|0.48s|0.027s|
|calc.nas|8089|0.068s|0.006s|
|quick_sort.nas|2768|0.107s|0s|
|bfs.nas|2471|1.763s|0.003s|

æŒ‡ä»¤è°ƒç”¨é¢‘ç‡:

|file|1st|2nd|3rd|4th|5th|
|:----|:----|:----|:----|:----|:----|
|pi.nas|callg|pop|mcallg|pnum|pone|
|fib.nas|calll|pnum|callg|less|jf|
|bp.nas|calll|callg|pop|callv|addeq|
|bigloop.nas|pnum|less|jf|callg|pone|
|mandelbrot.nas|callg|mult|loadg|pnum|pop|
|life.nas|calll|callv|pnum|jf|callg|
|ascii-art.nas|calll|pop|mcalll|callg|callb|
|calc.nas|calll|pop|pstr|mcalll|jmp|
|quick_sort.nas|calll|pop|jt|jf|less|
|bfs.nas|calll|pop|callv|mcalll|jf|

æŒ‡ä»¤æ€»è°ƒç”¨æ•°:

|file|1st|2nd|3rd|4th|5th|
|:----|:----|:----|:----|:----|:----|
|pi.nas|6000004|6000003|6000000|4000005|4000002|
|fib.nas|17622792|10573704|7049218|7049155|7049155|
|bp.nas|7081480|4227268|2764676|2617112|2065441|
|bigloop.nas|4000001|4000001|4000001|4000001|4000000|
|mandelbrot.nas|1519632|563856|290641|286795|284844|
|life.nas|2114371|974244|536413|534794|489743|
|ascii-art.nas|37906|22736|22402|18315|18292|
|calc.nas|191|124|109|99|87|
|quick_sort.nas|16226|5561|4144|3524|2833|
|bfs.nas|24707|16297|14606|14269|8672|

### version 7.0 (i5-8250U ubuntu-WSL on windows10 2021/6/29)

æ‰§è¡Œæ—¶é—´:

|file|total time|info|
|:----|:----|:----|
|pi.nas|0.15625s|great improvement|
|fib.nas|0.75s|great improvement|
|bp.nas|0.4218s(7162 epoch)|good improvement|
|bigloop.nas|0.09375s|great improvement|
|mandelbrot.nas|0.0312s|great improvement|
|life.nas|8.80s(windows) 1.25(ubuntu WSL)|little improvement|
|ascii-art.nas|0.015s|little improvement|
|calc.nas|0.0468s|little improvement|
|quick_sort.nas|0s|great improvement|
|bfs.nas|0.0156s|great improvement|

### version 8.0 (R9-5900HX ubuntu-WSL 2022/1/23)

æ‰§è¡Œæ—¶é—´:

|file|total time|info|
|:----|:----|:----|
|bf.nas|1100.19s||
|mandel.nas|28.98s||
|life.nas|0.56s|0.857s(windows)|
|ycombinator.nas|0.64s||
|fib.nas|0.28s||
|bfs.nas|0.156s|random result|
|pi.nas|0.0625s||
|bigloop.nas|0.047s||
|calc.nas|0.03125s|changed test file|
|mandelbrot.nas|0.0156s||
|ascii-art.nas|0s||
|quick_sort.nas|0s||

### version 9.0 (R9-5900HX ubuntu-WSL 2022/2/13)

æ‰§è¡Œæ—¶é—´:

|file|total time|info|
|:----|:----|:----|
|bf.nas|276.55s|great improvement|
|mandel.nas|28.16s||
|ycombinator.nas|0.59s||
|life.nas|0.2s|0.649s(windows)|
|fib.nas|0.234s|little improvement|
|bfs.nas|0.14s|random result|
|pi.nas|0.0625s||
|bigloop.nas|0.047s||
|calc.nas|0.0469s|changed test file|
|quick_sort.nas|0.016s|changed test file:100->1e4|
|mandelbrot.nas|0.0156s||
|ascii-art.nas|0s||

`bf.nas`æ˜¯ä¸ªéå¸¸æœ‰æ„æ€çš„æµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨nasalåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œå®ç°äº†ä¸€ä¸ªbrainfuckè§£é‡Šå™¨ï¼Œå¹¶ä¸”ç”¨è¿™ä¸ªè§£é‡Šå™¨ç»˜åˆ¶äº†ä¸€ä¸ªæ›¼å¾·å‹ƒç½—é›†åˆã€‚

åœ¨2022/2/17æ›´æ–°ä¸­æˆ‘ä»¬ç»™è¯æ³•åˆ†æå™¨æ·»åŠ äº†å¯¹`\e`çš„è¯†åˆ«é€»è¾‘ã€‚è¿™æ · `bfcolored.nas`å¯ä»¥ä½¿ç”¨ç‰¹åˆ«çš„ASCIIæ“ä½œå­—ç¬¦æ¥ç»˜åˆ¶å½©è‰²çš„æ›¼å¾·å‹ƒç½—é›†åˆ:

![mandelbrot](../pic/mandelbrot.png)

## __ä¸andyè§£é‡Šå™¨çš„ä¸åŒä¹‹å¤„__

### 1. å¿…é¡»ç”¨`var`å®šä¹‰å˜é‡

è¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨äº†æ›´åŠ ä¸¥æ ¼çš„è¯­æ³•æ£€æŸ¥æ¥ä¿è¯ä½ å¯ä»¥æ›´è½»æ¾åœ°debugã€‚è¿™æ˜¯éå¸¸æœ‰å¿…è¦çš„ä¸¥æ ¼ï¼Œå¦åˆ™debugä¼šéå¸¸ç—›è‹¦ã€‚

åœ¨Andyçš„è§£é‡Šå™¨ä¸­:

```javascript
import("lib.nas");
foreach(i;[0,1,2,3])
    print(i)
```

è¿™ä¸ªç¨‹åºä¼šæ­£å¸¸è¾“å‡º`0 1 2 3`ã€‚ç„¶è€Œè¿™ä¸ª`i`æ ‡è¯†ç¬¦å®é™…ä¸Šåœ¨è¿™é‡Œæ˜¯è¢«ç¬¬ä¸€æ¬¡å®šä¹‰ï¼Œè€Œä¸”æ²¡æœ‰ä½¿ç”¨`var`ã€‚æˆ‘è®¤ä¸ºè¿™æ ·çš„è®¾è®¡å¾ˆå®¹æ˜“è®©ä½¿ç”¨è€…è¿·æƒ‘ã€‚å¾ˆæœ‰å¯èƒ½å¾ˆå¤šä½¿ç”¨è€…éƒ½æ²¡æœ‰å‘ç°è¿™é‡Œå®é™…ä¸Šæ˜¯ç¬¬ä¸€æ¬¡å®šä¹‰`i`çš„åœ°æ–¹ã€‚æ²¡æœ‰ä½¿ç”¨`var`çš„å®šä¹‰ä¼šè®©ç¨‹åºå‘˜è®¤ä¸ºè¿™ä¸ª`i`ä¹Ÿè®¸æ˜¯åœ¨åˆ«çš„åœ°æ–¹å®šä¹‰çš„ã€‚

æ‰€ä»¥åœ¨è¿™ä¸ªæ–°çš„è§£é‡Šå™¨ä¸­ï¼Œæˆ‘ç›´æ¥ä½¿ç”¨ä¸¥æ ¼çš„è¯­æ³•æ£€æŸ¥æ–¹æ³•æ¥å¼ºè¡Œè¦æ±‚ç”¨æˆ·å¿…é¡»è¦ä½¿ç”¨`var`æ¥å®šä¹‰æ–°çš„å˜é‡æˆ–è€…è¿­ä»£å™¨ã€‚å¦‚æœä½ å¿˜äº†åŠ è¿™ä¸ªå…³é”®å­—ï¼Œå¹¶ä¸”ä½ æ²¡æœ‰åœ¨åˆ«çš„åœ°æ–¹å£°æ˜è¿‡è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆä½ å°±ä¼šå¾—åˆ°è¿™ä¸ª:

```javascript
[code] test.nas:2 undefined symbol "i".
foreach(i;[0,1,2,3])
[code] test.nas:3 undefined symbol "i".
    print(i)
```

### 2. (ç°åœ¨å·²ç»æ”¯æŒ) ä¸èƒ½åœ¨å®šä¹‰å‰ä½¿ç”¨å˜é‡

(__è¿‡æ—¶ä¿¡æ¯__: ç°åœ¨å·²ç»æ”¯æŒ)

```javascript
var a=func {print(b);}
var b=1;
a();
```

è¿™ä¸ªç¨‹åºåœ¨andyçš„è§£é‡Šå™¨ä¸­å¯ä»¥æ­£å¸¸è¿è¡Œå¹¶è¾“å‡ºå†…å®¹ã€‚ç„¶è€Œåœ¨è¿™ä¸ªæ–°çš„è§£é‡Šå™¨ä¸­ï¼Œä½ ä¼šå¾—åˆ°:

```javascript
[code] test.nas:1 undefined symbol "b".
var a=func {print(b);}
```

è¿™ä¸ªå·®å¼‚ä¸»è¦æ˜¯æ–‡æ³•ä½œç”¨åŸŸåˆ†æå¸¦æ¥çš„ã€‚åœ¨å¤§å¤šæ•°çš„è„šæœ¬è¯­è¨€è§£é‡Šå™¨ä¸­ï¼Œä»–ä»¬ä½¿ç”¨åŠ¨æ€çš„åˆ†ææ–¹å¼æ¥æ£€æµ‹ç¬¦å·æ˜¯ä¸æ˜¯å·²ç»å®šä¹‰è¿‡äº†ã€‚ç„¶è€Œï¼Œè¿™ç§åˆ†ææ–¹æ³•çš„ä»£ä»·å°±æ˜¯æ‰§è¡Œæ•ˆç‡ä¸ä¼šå¾ˆé«˜ã€‚ä¸ºäº†ä¿è¯è¿™ä¸ªè§£é‡Šå™¨èƒ½ä»¥æé«˜çš„é€Ÿåº¦è¿è¡Œï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯é™æ€çš„åˆ†ææ–¹å¼ï¼Œç”¨é™æ€è¯­è¨€ç±»ä¼¼çš„ç®¡ç†æ–¹å¼æ¥ç®¡ç†æ¯ä¸ªç¬¦å·å¯¹åº”çš„å†…å­˜ç©ºé—´ã€‚è¿™æ ·è™šæ‹Ÿæœºå°±ä¸éœ€è¦åœ¨è¿è¡Œçš„æ—¶å€™é¢‘ç¹æ£€æŸ¥ç¬¦å·æ˜¯å¦å­˜åœ¨ã€‚ä½†æ˜¯è¿™ä¹Ÿå¸¦æ¥äº†å·®å¼‚ã€‚åœ¨è¿™é‡Œä½ åªä¼šå¾—åˆ°`undefined symbol`ï¼Œè€Œä¸æ˜¯å¤§å¤šæ•°è„šæœ¬è¯­è¨€è§£é‡Šå™¨ä¸­é‚£æ ·å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚

è¿™ä¸ªå·®å¼‚åœ¨FGPRCæˆå‘˜ä¸­æœ‰ __äº‰è®®__ã€‚æ‰€ä»¥åœ¨æœªæ¥æˆ‘å¯èƒ½è¿˜æ˜¯ä¼šç”¨åŠ¨æ€çš„åˆ†ææ–¹æ³•æ¥è¿åˆå¤§å¤šæ•°çš„ç”¨æˆ·ã€‚

(2021/8/3 update) __ç°åœ¨æˆ‘ä½¿ç”¨äºŒæ¬¡æœç´¢æŠ½è±¡è¯­æ³•æ ‘çš„æ–¹å¼æ¥æ£€æµ‹ç¬¦å·æ˜¯å¦ä¼šè¢«å®šä¹‰ï¼Œæ‰€ä»¥åœ¨è¿™æ¬¡æ›´æ–°ä¹‹åï¼Œè¿™ä¸ªå·®å¼‚ä¸å¤å­˜åœ¨ã€‚__ ä¸è¿‡å¦‚æœä½ ç›´æ¥è·å–ä¸€ä¸ªè¿˜æœªè¢«å®šä¹‰çš„å˜é‡çš„å†…å®¹çš„è¯ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªç©ºæ•°æ®ï¼Œè€Œä¸æ˜¯`undefined error`ã€‚

### 3. é»˜è®¤ä¸å®šé•¿å‚æ•°

è¿™ä¸ªè§£é‡Šå™¨åœ¨è¿è¡Œæ—¶ï¼Œå‡½æ•°ä¸ä¼šå°†è¶…å‡ºå‚æ•°è¡¨çš„é‚£éƒ¨åˆ†ä¸å®šé•¿å‚æ•°æ”¾åˆ°é»˜è®¤çš„`arg`ä¸­ã€‚æ‰€ä»¥ä½ å¦‚æœä¸å®šä¹‰`arg`å°±ä½¿ç”¨å®ƒï¼Œé‚£ä½ åªä¼šå¾—åˆ°`undefined symbol`ã€‚

## __å †æ ˆè¿½è¸ªä¿¡æ¯__

å½“è§£é‡Šå™¨å´©æºƒæ—¶,å®ƒä¼šåé¦ˆé”™è¯¯äº§ç”Ÿè¿‡ç¨‹çš„å †æ ˆè¿½è¸ªä¿¡æ¯:

### 1. å†…ç½®å‡½æ•°`die`

`die`å‡½æ•°ç”¨äºç›´æ¥æŠ›å‡ºé”™è¯¯å¹¶ç»ˆæ­¢æ‰§è¡Œã€‚

```javascript
func()
{
    println("hello");
    die("error occurred this line");
    return;
}();
```

```javascript
hello
[vm] error: error occurred this line
[vm] native function error.
trace back:
        0x000000ac:     40 00 00 00 25      callb  0x25 <__builtin_die@0x41afc0> (lib.nas:131)
        0x000004f6:     3e 00 00 00 01      callfv 0x1 (a.nas:4)
        0x000004fa:     3e 00 00 00 00      callfv 0x0 (a.nas:6)
vm stack(0x7fffcd21bc68<sp+80>, limit 10, total 12):
  0x0000005b    | null |
  0x0000005a    | pc   | 0x4f6
  0x00000059    | addr | 0x7fffcd21bc78
  0x00000058    | nil  |
  0x00000057    | str  | <0x138ff60> error occurred t...
  0x00000056    | nil  |
  0x00000055    | func | <0x13445b0> entry:0x4f0
  0x00000054    | pc   | 0x4fa
  0x00000053    | addr | 0x0
  0x00000052    | nil  |
```

### 2. æ ˆæº¢å‡ºä¿¡æ¯

è¿™æ˜¯ä¸€ä¸ªä¼šå¯¼è‡´æ ˆæº¢å‡ºçš„ä¾‹å­:

```javascript
func(f){
    return f(f);
}(
    func(f){
        f(f);
    }
)();
```

```javascript
[vm] stack overflow
trace back:
        0x000004fb:     3e 00 00 00 01      callfv 0x1 (a.nas:5)
        0x000004fb:     1349 same call(s)
        0x000004f3:     3e 00 00 00 01      callfv 0x1 (a.nas:2)
        0x000004ff:     3e 00 00 00 01      callfv 0x1 (a.nas:3)
vm stack(0x7fffd3781d58<sp+80>, limit 10, total 8108):
  0x00001ffb    | func | <0x15f8d90> entry:0x4f9
  0x00001ffa    | func | <0x15f8d90> entry:0x4f9
  0x00001ff9    | pc   | 0x4fb
  0x00001ff8    | addr | 0x7fffd37a1748
  0x00001ff7    | nil  |
  0x00001ff6    | func | <0x15f8d90> entry:0x4f9
  0x00001ff5    | nil  |
  0x00001ff4    | func | <0x15f8d90> entry:0x4f9
  0x00001ff3    | pc   | 0x4fb
  0x00001ff2    | addr | 0x7fffd37a16e8
```

### 3. è¿è¡Œæ—¶é”™è¯¯

å¦‚æœåœ¨æ‰§è¡Œçš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œç¨‹åºä¼šç›´æ¥ç»ˆæ­¢æ‰§è¡Œ:

```javascript
func(){
    return 0;
}()[1];
```

```javascript
[vm] callv: must call a vector/hash/string
trace back:
        0x000004f4:     3b 00 00 00 00      callv  0x0 (a.nas:3)
vm stack(0x7fffff539c28<sp+80>, limit 10, total 1):
  0x00000050    | num  | 0
```

### 4. è¯¦ç»†çš„å´©æºƒä¿¡æ¯

ä½¿ç”¨å‘½ä»¤ __`-d`__ æˆ– __`--detail`__ åï¼Œtrace backä¿¡æ¯ä¼šåŒ…å«æ›´å¤šçš„ç»†èŠ‚å†…å®¹:

```javascript
hello
[vm] error: error occurred this line
[vm] native function error.
trace back:
        0x000000ac:     40 00 00 00 25      callb  0x25 <__builtin_die@0x41afc0> (lib.nas:131)
        0x000004f6:     3e 00 00 00 01      callfv 0x1 (a.nas:4)
        0x000004fa:     3e 00 00 00 00      callfv 0x0 (a.nas:6)
vm stack(0x7ffff42f3d08<sp+80>, limit 10, total 12):
  0x0000005b    | null |
  0x0000005a    | pc   | 0x4f6
  0x00000059    | addr | 0x7ffff42f3d18
  0x00000058    | nil  |
  0x00000057    | str  | <0x1932480> error occurred t...
  0x00000056    | nil  |
  0x00000055    | func | <0x18e6ad0> entry:0x4f0
  0x00000054    | pc   | 0x4fa
  0x00000053    | addr | 0x0
  0x00000052    | nil  |
registers(main):
  [ pc     ]    | pc   | 0xac
  [ global ]    | addr | 0x7ffff42f3808
  [ localr ]    | addr | 0x7ffff42f3d68
  [ memr   ]    | addr | 0x0
  [ funcr  ]    | func | <0x18fbe50> entry:0xac
  [ upvalr ]    | nil  |
  [ canary ]    | addr | 0x7ffff43137f8
  [ top    ]    | addr | 0x7ffff42f3db8
global(0x7ffff42f3808<sp+0>):
  0x00000000    | func | <0x18d62d0> entry:0x5
  0x00000001    | func | <0x18d7e40> entry:0xc
  0x00000002    | func | <0x18d63f0> entry:0x14
  0x00000003    | func | <0x18d6490> entry:0x1c
  0x00000004    | func | <0x18d6530> entry:0x23
  0x00000005    | func | <0x18d65d0> entry:0x29
  0x00000006    | func | <0x18d6670> entry:0x31
  0x00000007    | func | <0x18d6710> entry:0x39
  0x00000008    | func | <0x18d67b0> entry:0x40
  0x00000009    | func | <0x18d6850> entry:0x47
  0x0000000a    | func | <0x18d7e60> entry:0x4e
  0x0000000b    | func | <0x18cb4e0> entry:0x54
  0x0000000c    | func | <0x18cb580> entry:0x5d
  0x0000000d    | func | <0x18cb620> entry:0x6a
  0x0000000e    | func | <0x18cb6c0> entry:0x71
  0x0000000f    | func | <0x18cb760> entry:0x78
  0x00000010    | func | <0x18cb800> entry:0x7f
  0x00000011    | func | <0x18cb8a0> entry:0x87
  0x00000012    | func | <0x18cb940> entry:0x8f
  0x00000013    | func | <0x18cb9e0> entry:0x96
  0x00000014    | func | <0x18cba80> entry:0x9d
  0x00000015    | func | <0x18fbdb0> entry:0xa3
  0x00000016    | func | <0x18fbe50> entry:0xac
  0x00000017    | func | <0x18fbef0> entry:0xb4
  0x00000018    | func | <0x18fbf90> entry:0xbb
  0x00000019    | func | <0x18fc030> entry:0xc5
  0x0000001a    | func | <0x18fc0d0> entry:0xdc
  0x0000001b    | func | <0x18fc170> entry:0xe4
  0x0000001c    | func | <0x18fc210> entry:0xec
  0x0000001d    | func | <0x18fc2b0> entry:0xf4
  0x0000001e    | func | <0x18fc350> entry:0xfc
  0x0000001f    | func | <0x18cbaa0> entry:0x103
  0x00000020    | func | <0x18f3630> entry:0x10a
  0x00000021    | func | <0x18f36d0> entry:0x111
  0x00000022    | func | <0x18f3770> entry:0x11e
  0x00000023    | func | <0x18f3810> entry:0x125
  0x00000024    | func | <0x18f38b0> entry:0x131
  0x00000025    | func | <0x18f3950> entry:0x13c
  0x00000026    | func | <0x18f39f0> entry:0x147
  0x00000027    | func | <0x18f3a90> entry:0x152
  0x00000028    | func | <0x18f3b30> entry:0x15d
  0x00000029    | func | <0x18f3bd0> entry:0x174
  0x0000002a    | func | <0x18f3c70> entry:0x18d
  0x0000002b    | func | <0x18f6710> entry:0x198
  0x0000002c    | func | <0x18f67b0> entry:0x1a4
  0x0000002d    | func | <0x18f6850> entry:0x1bd
  0x0000002e    | func | <0x18f68f0> entry:0x1e9
  0x0000002f    | func | <0x18f6990> entry:0x1fb
  0x00000030    | func | <0x18f6a30> entry:0x20c
  0x00000031    | func | <0x18f6ad0> entry:0x237
  0x00000032    | hash | <0x191f780> {14 val}
  0x00000033    | func | <0x18df660> entry:0x29b
  0x00000034    | hash | <0x191f7a0> {9 val}
  0x00000035    | hash | <0x191f7c0> {18 val}
  0x00000036    | hash | <0x191f7e0> {16 val}
  0x00000037    | hash | <0x191f800> {4 val}
  0x00000038    | hash | <0x191f820> {1 val}
  0x00000039    | hash | <0x191f840> {1 val}
  0x0000003a    | num  | 0.0174533
  0x0000003b    | num  | 0.5925
  0x0000003c    | num  | 0.3048
  0x0000003d    | num  | 3.7854
  0x0000003e    | num  | 0.0254
  0x0000003f    | num  | 2.2046
  0x00000040    | num  | 1.6878
  0x00000041    | num  | 0.5144
  0x00000042    | num  | 0.2642
  0x00000043    | num  | 0.4536
  0x00000044    | num  | 3.2808
  0x00000045    | num  | 39.3701
  0x00000046    | num  | 0.00054
  0x00000047    | num  | 1.9438
  0x00000048    | num  | 1852
  0x00000049    | num  | 57.2958
  0x0000004a    | func | <0x18e6490> entry:0x489
  0x0000004b    | func | <0x18e6530> entry:0x49c
  0x0000004c    | func | <0x18e65d0> entry:0x4a8
  0x0000004d    | func | <0x18e6670> entry:0x4b5
  0x0000004e    | func | <0x18e6710> entry:0x4c2
  0x0000004f    | hash | <0x191f8b0> {5 val}
local(0x7ffff42f3d68<sp+86>):
  0x00000000    | nil  |
  0x00000001    | str  | <0x1932480> error occurred t...
```

## __è°ƒè¯•å™¨__

åœ¨v8.0ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸ºnasalæ·»åŠ äº†è°ƒè¯•å™¨ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ç¨‹åºçš„æ—¶å€™åŒæ—¶çœ‹åˆ°æºä»£ç å’Œç”Ÿæˆçš„å­—èŠ‚ç å¹¶ä¸”å•æ­¥æ‰§è¡Œã€‚

ä½¿ç”¨è¿™ä¸ªå‘½ä»¤`./nasal -dbg xxx.nas`æ¥å¯ç”¨è°ƒè¯•å™¨ï¼Œæ¥ä¸‹æ¥è°ƒè¯•å™¨ä¼šæ‰“å¼€æ–‡ä»¶å¹¶è¾“å‡ºä»¥ä¸‹å†…å®¹:

```javascript
[debug] nasal debug mode
input 'h' to get help

source code:
-->     import("lib.nas");
        var fib=func(x)
        {
                if(x<2) return x;
                return fib(x-1)+fib(x-2);
        }
        for(var i=0;i<31;i+=1)
                print(fib(i),'\n');
next bytecode:
-->     0x00000000:     01 00 00 00 4f      intg   0x4f (a.nas:0)
        0x00000001:     0b 00 00 00 05      newf   0x5 (lib.nas:5)
        0x00000002:     02 00 00 00 02      intl   0x2 (lib.nas:5)
        0x00000003:     0d 00 00 00 00      para   0x0 ("filename") (lib.nas:5)
        0x00000004:     32 00 00 00 07      jmp    0x7 (lib.nas:5)
        0x00000005:     40 00 00 00 24      callb  0x24 <__builtin_import@0x419b20> (lib.nas:6)
        0x00000006:     4a 00 00 00 00      ret    0x0 (lib.nas:6)
        0x00000007:     03 00 00 00 00      loadg  0x0 (lib.nas:5)
vm stack(0x7fffe05e3190<sp+79>, limit 5, total 0)
>>
```

å¦‚æœéœ€è¦æŸ¥çœ‹å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥è¾“å…¥`h`è·å–å¸®åŠ©ä¿¡æ¯ã€‚

```bash
<option>
        h,   help      | get help
        bt,  backtrace | get function call trace
        c,   continue  | run program until break point or exit
        f,   file      | see all the compiled files
        g,   global    | see global values
        l,   local     | see local values
        u,   upval     | see upvalue
        r,   register  | show vm register detail
        a,   all       | show global,local and upvalue
        n,   next      | execute next bytecode
        q,   exit      | exit debugger
<option> <filename> <line>
        bk,  break     | set break point
```

å½“è¿è¡Œè°ƒè¯•å™¨çš„æ—¶å€™ï¼Œä½ å¯ä»¥çœ‹åˆ°ç°åœ¨çš„æ“ä½œæ•°æ ˆä¸Šåˆ°åº•æœ‰äº›ä»€ä¹ˆæ•°æ®ã€‚
è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©ä½ è°ƒè¯•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¸®åŠ©ä½ ç†è§£è¿™ä¸ªè™šæ‹Ÿæœºæ˜¯å¦‚ä½•å·¥ä½œçš„:

```javascript
source code:
        import("lib.nas");
        var fib=func(x)
        {
-->             if(x<2) return x;
                return fib(x-1)+fib(x-2);
        }
        for(var i=0;i<31;i+=1)
                print(fib(i),'\n');
next bytecode:
        0x00000458:     4a 00 00 00 00      ret    0x0 (lib.nas:463)
        0x00000459:     03 00 00 00 4c      loadg  0x4c (lib.nas:463)
        0x0000045a:     0b 00 00 04 5e      newf   0x45e (a.nas:2)
        0x0000045b:     02 00 00 00 02      intl   0x2 (a.nas:2)
        0x0000045c:     0d 00 00 00 1c      para   0x1c ("x") (a.nas:2)
        0x0000045d:     32 00 00 04 6d      jmp    0x46d (a.nas:2)
-->     0x0000045e:     39 00 00 00 01      calll  0x1 (a.nas:4)
        0x0000045f:     2d 00 00 00 02      lessc  0x2 (2) (a.nas:4)
vm stack(0x7fffe05e3190<sp+79>, limit 5, total 6):
  0x00000054    | pc   | 0x476
  0x00000053    | addr | 0x0
  0x00000052    | num  | 0
  0x00000051    | nil  |
  0x00000050    | nil  |
>>
```
